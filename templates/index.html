<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Assistance System - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-mode.css') }}">
    <style>
        :root {
            --primary: #1B5E3A;
            --secondary: #2E7D5C;
            --accent: #4B9B6E;
            --light: #A8D5BA;
            --alert: #6BBF8A;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: #f5f5f5;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 2rem;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: bold;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .profile {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 0.5rem;
            display: none;
            min-width: 160px;
        }

        .profile:hover .profile-dropdown {
            display: block;
        }

        .profile-dropdown a {
            display: block;
            padding: 0.5rem 1rem;
            color: var(--secondary);
            text-decoration: none;
            border-radius: 4px;
        }

        .profile-dropdown a:hover {
            background: var(--light);
        }

        .notifications {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            background: var(--alert);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
            position: absolute;
            top: -8px;
            right: -8px;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            bottom: 0;
            width: 250px;
            background: white;
            padding: 1rem;
            transition: transform 0.3s ease;
        }

        .nav-item {
            padding: 0.8rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--secondary);
        }

        /* Hover effect - light green */
        .nav-item:hover {
            background-color: var(--light);
            color: var(--primary);
            transition: all 0.2s ease;
        }

        /* Active/clicked state - dark green */
        .nav-item.active {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            margin-top: 60px;
            margin-left: 250px;
            padding: 2rem;
            transition: margin-left 0.3s ease;
        }

        .greeting-section {
            margin-bottom: 2rem;
        }

        .time-based-greeting {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .motivational-quote {
            color: var(--secondary);
            font-style: italic;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }

        /* Appointments Styles */
        .appointments-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .appointments-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: var(--light);
            color: var(--primary);
            border-radius: 5px;
            cursor: pointer;
        }

        .appointments-tab.active {
            background: var(--primary);
            color: white;
        }

        .appointment-list {
            display: none;
        }

        .appointment-list.active {
            display: block;
        }

        .appointment-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .appointment-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .notes-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            z-index: 3000;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-height: 200px;
        }

        .card h3 {
            color: var(--secondary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .appointment-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .medication-list {
            list-style: none;
            padding: 0;
        }

        .medication-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .vital-chart {
            position: relative;
            height: 230px;
            padding-bottom: 65px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-secondary {
            background: var(--light);
            color: var(--primary);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Chatbot Styles */
        .chatbot-icon {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0) 20%),
                        linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3),
                        inset 0 -4px 10px rgba(0, 0, 0, 0.1),
                        inset 0 4px 10px rgba(255, 255, 255, 0.3);
            animation: waterdrop-pulse 4s ease-in-out infinite;
        }

        @keyframes waterdrop-pulse {
            0% { transform: scale(0.95); border-radius: 50%; }
            50% { transform: scale(1.05); border-radius: 44% 56% 53% 47% / 48% 52% 48% 52%; }
            100% { transform: scale(0.95); border-radius: 50%; }
        }

        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 2rem;
            width: calc(80%);
            height: calc(79%);
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
            .card-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Additional styles for section content */
        h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #upload-text-btn {
        position: absolute; /* Absolutely position the button */
        right: 5%; /* Stick the button to the right of the header */
        top: 17%; /* Vertically center the button */
        transform: translateY(-50%); /* Adjust to perfectly center the button */
        padding: 10px 20px;
        background-color: var(--secondary); /* Green color */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        }

        #upload-text-btn:hover {
        background-color: #45a049; /* Darker green on hover */
        }

        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .document-info {
            flex-grow: 1;
        }

        .document-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .document-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .document-type-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }

        .document-type-text {
            background-color: #e9ecef;
            color: #495057;
        }

        .document-type-prescription {
            background-color: #cce5ff;
            color: #004085;
        }

        .view-document-btn {
            padding: 4px 8px;
            background-color: rgba(0, 222, 155, 0.5);
            color: var(--primary);
            border: none;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
            transition: background-color 0.3s ease;
        }

        .view-document-btn:hover{
            background-color: rgba(0, 204, 222, 0.6);
        }

        .delete-document-btn {
            padding: 4px 8px;
            background-color: #ff0019;
            color: var(--primary);
            border: none;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
            transition: background-color 0.3s ease;
        }

        .delete-document-btn:hover {
            background-color: #ff763f;
        }

        /* Upload overlay styles */
        .upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            z-index: 2000;
            background: rgba(255, 255, 255, 0.9);
            animation: overlayFadeIn 0.3s ease-out;
        }

        @keyframes overlayFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
                transform: scale(0.95); /* Slightly scale down at the start */
            }
            to {
                opacity: 1;
                backdrop-filter: blur(8px); /* Increase blur for a more premium feel */
                transform: scale(1); /* Scale back to normal */
            }
        }


        .upload-overlay-content {
            background: var(--light);
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
        }


        @keyframes contentSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .upload-overlay-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .upload-overlay-header h3 img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .close-overlay {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--secondary);
        }

        .overlay-textimage{
            background: rgba(0, 0, 0, 0.6); /* Slightly dark opaque background */
            backdrop-filter: blur(4px); /* Reduced blur for a more professional appearance */
        }

        .close-overlay:hover {
            background: var(--light);
            transform: rotate(90deg);
        }

        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Upload button styling */
        .upload-form button[type="submit"] {
            padding: 0.875rem 1.5rem;
            background: #0d6efd;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .upload-form button[type="submit"]:hover {
            background: #0b5ed7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
        }

        .upload-form button[type="submit"]:active {
            transform: translateY(0);
        }
        

        /* Modern file input styling */
        .file-input-container {
            position: relative;
            width: 100%;
            height: 200px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent);
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
        }

        .file-input-container:hover {
            border-color: #0d6efd;
            background: rgba(13, 110, 253, 0.05);
        }

        .file-input-container input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            text-align: center;
            padding: 1rem;
        }

        .file-input-icon {
            width: 48px;
            height: 48px;
            color: var(--secondary);
        }

        .file-input-text {
            font-size: 1rem;
            color: var(--secondary);
        }

        .file-input-hint {
            font-size: 0.875rem;
            color: var(--secondary);
            opacity: 0.7;
        }

        /* Upload status styling */
        .upload-status {
            padding: 1rem;
            border-radius: 10px;
            font-size: 0.875rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-success {
            background: rgba(25, 135, 84, 0.1);
            color: #198754;
            border: 1px solid rgba(25, 135, 84, 0.2);
        }

        .upload-error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        /* Loading indicator styling */
        .loading {
            display: none;
            padding: 1rem;
            text-align: center;
            color: var(--secondary);
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--secondary);
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Selected file preview */
        .file-preview {
            display: none;
            padding: 1rem;
            background: var(--primary);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .file-preview.active {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-preview-icon {
            width: 24px;
            height: 24px;
            color: var(--secondary);
        }

        .file-preview-info {
            flex: 1;
        }

        .file-preview-name {
            font-size: 0.875rem;
            color: var(--primary);
            font-weight: 500;
        }

        .file-preview-size {
            font-size: 0.75rem;
            color: var(--secondary);
        }

        /* #################   CHAT HISTORY   ################## */
        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-item {
            display: flex;
            align-items: center;
            background-color: #fff;
            transition: background-color 0.2s ease;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1rem;
        }

        .chat-item:hover {
            background-color: #f9f9f9;
        }

        .chat-header {  
            margin-right: auto; /* This pushes everything else to the right */
        }

        .chat-title{
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: #333;
        }

        .chat-created_at{
            display: block;
            margin-top: 0.15rem;  
            font-size: 0.6rem;  
            border-radius: 8px;
            color: var(--primary);
            backdrop-filter: blur(4px);
            max-width: fit-content;
            opacity: 0.9;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .chat-created_at:hover {
            opacity: 1; 
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .delete-chat-btn {
            background-color: #e74c3c; /* Red color */
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.8rem;
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Center items vertically */
            gap: 0.25rem; /* Add some space between icon and text */
        }

        .delete-chat-btn:hover {
            background-color: #c0392b; /* Darker red */
        }

        .edit-chat-btn{
            background-color: var(--secondary); /* Red color */
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.8rem;
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Center items vertically */
            gap: 0.25rem; /* Add some space between icon and text */
        }

        .edit-chat-btn:hover{
            background-color: var(--primary);
        }

        .edit-title-input {
            transition: border-color 0.3s;
        }

        .edit-title-input:focus {
            border-color: #0056b3;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }


        /* #################       CHATTING          ################    */

        #chat-container {
            flex-grow: 1;
            border-radius: 10px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(255, 255, 255, 0);
            color: var(--primary);
            border-color: var(--primary);
            box-sizing: border-box;
            padding-bottom: 50px;
        }

        .button-back-to-chat-history{
            padding: 4px 15px 4px 4px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            background: #dadada;
        }

        .button-back-to-chat-history:hover{
            background:var(--light);
            border: none;
        }

        .add-chat-description-btn{
            padding: 4px 15px 4px 4px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            background: #dadada;
        }

        .add-chat-description-btn:hover{
            background: var(--light);
            border: none;
        }
        /* Message styles */
        .message {
            margin-bottom: 5px;
            padding: 15px;
            border-radius: 8px;
            max-width: 80%;
            position: relative;
            color: var(--primary);
            border-color: var(--primary);
        }

        .message-content {
            line-height: 1.5;
            white-space: pre-wrap;  /* Preserves whitespace and line breaks */
        }

        .message-content p {
            margin-bottom: 1rem;
        }

        /* some spacing after headers */
        .message-content h1, 
        .message-content h2, 
        .message-content h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .message-content ul, 
        .message-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .message-content li {
            margin-bottom: 0.5rem;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        } 

        .message-content strong {
            font-weight: 600;
            color: var(--primary);
        }

        .message-content ul, 
        .message-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .message-content br {
            display: block;
            margin-top: 0.5rem;
        }

        .user-message {
            background-color: var(--light);
            margin-left: auto;
            margin-bottom: 10px;
            border-radius: 40px;
            padding-left: 20px;
        }

        .assistant-message {
            margin-right: auto;
            margin-bottom: 10px;

        }

        .timestamp {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Form styles [the chatbot input section] */
        #message-form {
            display: flex;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px;
            gap: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            width: 90%;
            max-width: 600px;
            transition: all 0.2s ease;
            border: 1px solid #f0f0f0;
        }

        #message-form:hover {
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
        }

        /* Input field styles */
        #message-input {
            flex-grow: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            background-color: #f9f9f9;
            color: #333;
            transition: background-color 0.2s ease;
        }

        #message-input:focus {
            background-color: #f5f5f5;
            outline: none;
        }

        /* Button styles */
        #message-form button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 14px;
            background-color: #0070f3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        #message-form button:hover {
            background-color: #0060df;
        }

        #message-form button:active {
            transform: scale(0.97);
        }

        /* Button text and icon */
        .button-text {
            margin-right: 6px;
        }

        .button-icon {
            font-size: 16px;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            #message-form {
                padding: 6px;
                gap: 6px;
                border-radius: 10px;
            }
            
            #message-input {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            #message-form button {
                padding: 8px 12px;
            }
        }

        #headerLogo {
            transition: opacity 0.2s ease;  /* Apply a fade effect */
            opacity: 1;  /* Ensure it's visible initially */
        }
        .hidden {
            opacity: 0;
        }

        .chat-summary p {
            user-select: text;
            cursor: text;
        }

        .add-chat-description-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .fa-spinner {
            margin-right: 5px;
        }

        .chat-summary.error {
            color: #dc3545;
            font-style: italic;
        }

        /*###########  Voice Mode Overlay Styles  ###############*/

        #voice-mode-overlay {
            /* Instead of centering vertically, align to the top */
            align-items: flex-start;
            /* padding-top: 20px;  Optional: adds space from the very top */
        }

        .voice-overlay-container {
            position: relative;
            width: calc(1.2 * 60%);
            max-width: 90vw;
            margin-left: calc(0.2 * 60%);
            padding: 2rem;
            overflow: hidden;
            text-align: center;
        }

        .state-label {
        font-size: 1rem;
        font-weight: 700;
        font-style: inherit;
        color: #007c74;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        }

        .animation-wrapper {
        position: relative;
        width: 8rem;
        height: 8rem;
        margin: 0 auto 1rem auto;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.5s ease-in-out;
        }

        .water-drop-base {
        position: absolute;
        inset: 0;
        border-radius: 50%;
        overflow: hidden;
        }
        .color-blob {
        position: absolute;
        border-radius: 50%;
        filter: blur(15px);
        mix-blend-mode: screen;
        }
        .highlight {
        position: absolute;
        width: 20%;
        height: 20%;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        top: 20%;
        left: 70%;
        filter: blur(2px);
        animation: shine 4s ease-in-out infinite;
        }

        /* Keyframes */
        @keyframes waterdrop-pulse {
            0% { transform: scale(0.95); border-radius: 50%; }
            50% { transform: scale(1.05); border-radius: 44% 56% 53% 47% / 48% 52% 48% 52%; }
            100% { transform: scale(0.95); border-radius: 50%; }
        }

        @keyframes color-shift { 
            0% { opacity: 0.3; } 
            50% { opacity: 0.7; } 
            100% { opacity: 0.3; } 
        }

        @keyframes float {
            0% { transform: translateY(0px) translateX(0px); }
            33% { transform: translateY(-10px) translateX(5px); }
            66% { transform: translateY(5px) translateX(-8px); }
            100% { transform: translateY(0px) translateX(0px); }
        }

        @keyframes shine {
            0% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 0.8; transform: scale(1.1); }
            100% { opacity: 0.2; transform: scale(0.8); }
        }

        /* Listening Animation */
        .listening-animation {
        position: relative;
        width: 100%;
        height: 100%;
        display: none;
        }
        .listening-water-drop {
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0) 20%),
                    linear-gradient(135deg, #60a5fa, #3b82f6);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3),
                    inset 0 -4px 10px rgba(0, 0, 0, 0.1),
                    inset 0 4px 10px rgba(255, 255, 255, 0.3);
        animation: waterdrop-pulse 4s ease-in-out infinite;
        overflow: hidden;
        }
        .listening-blob-1 {
        background-color: rgba(96, 165, 250, 0.7);
        width: 70%;
        height: 70%;
        top: 15%;
        left: 15%;
        animation: color-shift 5s ease-in-out infinite, float 7s ease-in-out infinite;
        }
        .listening-blob-2 {
        background-color: rgba(167, 139, 250, 0.7);
        width: 60%;
        height: 60%;
        top: 20%;
        left: 20%;
        animation: color-shift 4s ease-in-out 0.5s infinite, float 8s ease-in-out 0.3s infinite;
        }
        .listening-blob-3 {
        background-color: rgba(52, 211, 153, 0.7);
        width: 50%;
        height: 50%;
        top: 25%;
        left: 25%;
        animation: color-shift 6s ease-in-out 1s infinite, float 9s ease-in-out 0.6s infinite;
        }

        /* Processing Animation */
        .processing-animation {
        position: relative;
        width: 100%;
        height: 100%;
        display: none;
        }
        .processing-water-drop {
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0) 20%),
                    linear-gradient(135deg, #a78bfa, #8b5cf6);
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3),
                    inset 0 -4px 10px rgba(0, 0, 0, 0.1),
                    inset 0 4px 10px rgba(255, 255, 255, 0.3);
        animation: waterdrop-pulse 4s ease-in-out infinite;
        overflow: hidden;
        }
        .processing-blob-1 {
        background-color: rgba(167, 139, 250, 0.7);
        width: 70%;
        height: 70%;
        top: 15%;
        left: 15%;
        animation: color-shift 5s ease-in-out infinite, float 7s ease-in-out infinite;
        }
        .processing-blob-2 {
        background-color: rgba(124, 58, 237, 0.7);
        width: 60%;
        height: 60%;
        top: 20%;
        left: 20%;
        animation: color-shift 4s ease-in-out 0.5s infinite, float 8s ease-in-out 0.3s infinite;
        }
        .processing-blob-3 {
        background-color: rgba(96, 165, 250, 0.7);
        width: 50%;
        height: 50%;
        top: 25%;
        left: 25%;
        animation: color-shift 6s ease-in-out 1s infinite, float 9s ease-in-out 0.6s infinite;
        }
        .dna-helix {
        position: absolute;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        }
        .dna-strand {
        position: absolute;
        width: 1.5rem;
        height: 0.375rem;
        background-color: white;
        border-radius: 9999px;
        opacity: 0.7;
        left: 50%;
        transform: translateX(-50%);
        }

        /* Speaking Animation */
        .speaking-animation {
        position: relative;
        width: 100%;
        height: 100%;
        display: none;
        }
        .speaking-water-drop {
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0) 20%),
                    linear-gradient(135deg, #34d399, #10b981);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3),
                    inset 0 -4px 10px rgba(0, 0, 0, 0.1),
                    inset 0 4px 10px rgba(255, 255, 255, 0.3);
        animation: waterdrop-pulse 4s ease-in-out infinite;
        overflow: hidden;
        }
        .speaking-blob-1 {
        background-color: rgba(52, 211, 153, 0.7);
        width: 70%;
        height: 70%;
        top: 15%;
        left: 15%;
        animation: color-shift 5s ease-in-out infinite, float 7s ease-in-out infinite;
        }
        .speaking-blob-2 {
        background-color: rgba(16, 185, 129, 0.7);
        width: 60%;
        height: 60%;
        top: 20%;
        left: 20%;
        animation: color-shift 4s ease-in-out 0.5s infinite, float 8s ease-in-out 0.3s infinite;
        }
        .speaking-blob-3 {
        background-color: rgba(6, 182, 212, 0.7);
        width: 50%;
        height: 50%;
        top: 25%;
        left: 25%;
        animation: color-shift 6s ease-in-out 1s infinite, float 9s ease-in-out 0.6s infinite;
        }
        .waveform {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            height: 100%;
            width: 80%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .waveform-bar {
            width: 0.5rem;
            background-color: white;
            border-radius: 9999px;
            opacity: 0.8;
            height: 16px;
        }
        .heartbeat-line {
            position: absolute;
            bottom: 1.5rem;
            width: 100%;
            height: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        /* Voice Controls (Buttons) */
        .voice-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        .glow-on-hover {
            position: relative;
            padding: 12px 24px;
            border: none;
            background: #007bff; /* Blue for primary button */
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .glow-on-hover:hover {
            background: #00d29e; /* Lighter red on hover */
        }

        .glow-on-hover.red {
            background: #dc3545; /* Red for cancel button */
        }

        .glow-on-hover.red:hover {
            background: #ff8400; /* Lighter red on hover */
        }

        .btn-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 10%, transparent 70%);
            animation: btnPulse 2s infinite;
            opacity: 0;
        }
        @keyframes btnPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { opacity: 0.3; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        /* Additional keyframe for heartbeat (if not defined elsewhere) */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.95); opacity: 0.8; }
        }

        /* Dash animation for heartbeat line */
        @keyframes dash {
            0% { stroke-dashoffset: 100; }
            50% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: 100; }
        }

        /* Wave animation for DNA strands (if not defined elsewhere) */
        @keyframes wave {
            0% { left: 30%; width: 24px; }
            50% { left: 70%; width: 12px; }
            100% { left: 30%; width: 24px; }
        }

        /* Speak animation for waveform bars (if not defined elsewhere) */
        @keyframes speak {
            0% { height: 16px; opacity: 0.6; }
            50% { height: 36px; opacity: 0.9; }
            100% { height: 16px; opacity: 0.6; }
        }


        #main-content.voice-active {
            transition: margin-top 0.3s ease;
        }


        /* ######## ENHANCED SETTINGS PAGE STYLES ######## */

.settings-grid {
    display: grid;
    grid-template-columns: 1fr; /* Stack cards on mobile */
    gap: 2rem;
}

@media (min-width: 992px) { /* Adjust breakpoint as needed */
    .settings-grid {
        grid-template-columns: repeat(2, 1fr); /* Two columns on larger screens */
    }
}

.settings-card {
    display: flex;
    flex-direction: column;
    background-color: var(--card-bg, white); /* Use CSS var for dark mode compatibility */
    border-radius: 12px; /* Slightly larger radius */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Softer shadow */
    overflow: hidden; /* Ensure content respects border radius */
    border: 1px solid var(--border-color, #e9ecef); /* Subtle border */
}

.settings-card .card-header {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem 1.5rem;
    background-color: var(--header-bg, #f8f9fa); /* Light grey header bg */
    border-bottom: 1px solid var(--border-color, #e9ecef);
}

.settings-card .card-header i {
    color: var(--primary);
    font-size: 1.1rem;
}

.settings-card .card-header h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-primary, var(--secondary));
}

.settings-card .card-content {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem; /* Space between elements/forms in the card */
}

/* Profile Specific */
.profile-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1rem; /* Space below header */
}

.avatar-wrapper {
    position: relative;
    width: 80px; /* Smaller avatar */
    height: 80px;
    flex-shrink: 0;
}

.profile-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid var(--light);
}

.upload-btn-overlay {
    position: absolute;
    inset: 0; /* Cover the entire avatar */
    background-color: rgba(0, 0, 0, 0.4);
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.3s ease;
    cursor: pointer;
    font-size: 0.8rem;
}
.upload-btn-overlay i {
    font-size: 1.2rem;
    margin-bottom: 0.2rem;
}

.avatar-wrapper:hover .upload-btn-overlay {
    opacity: 1;
}

.user-identity {
    display: flex;
    flex-direction: column;
}

.user-identity h4 {
    margin: 0 0 0.2rem 0;
    font-size: 1.3rem;
    color: var(--text-primary, #333);
}

.member-since {
    font-size: 0.85rem;
    color: var(--text-secondary, #6c757d);
}

/* Form Styling Enhancements */
.settings-card form {
    width: 100%;
}

.settings-card form h4 { /* Sub-headings within cards */
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--secondary);
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color, #eee);
}
.settings-card form h4:first-of-type {
    margin-top: 0; /* No top margin for the first heading */
}


.form-group, .form-group-inline, .form-group-toggle {
    display: flex;
    flex-direction: column;
    gap: 0.5rem; /* Space between label and input */
    margin-bottom: 1.25rem; /* Space between form groups */
}

.form-group-inline {
    /* For label + description + action layout */
}

.form-group-toggle {
    flex-direction: row;
    justify-content: space-between;
    align-items: flex-start; /* Align items to top for multi-line text */
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}
.form-group-toggle > div { /* Container for label and description */
    flex-grow: 1;
}


.settings-card label { /* More specific selector */
    font-weight: 500;
    color: var(--text-secondary, var(--secondary));
    font-size: 0.9rem;
}

.form-input {
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color, #ced4da);
    border-radius: 6px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    font-size: 1rem;
    background-color: var(--input-bg, white);
    color: var(--text-primary, #333);
}

.form-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(27, 94, 58, 0.15); /* Focus ring */
}
.form-input[readonly] {
    background-color: var(--input-readonly-bg, #e9ecef);
    cursor: default;
}

.input-with-action {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.input-with-action .form-input {
    flex-grow: 1;
}

.btn-icon {
    background: none;
    border: none;
    color: var(--accent);
    padding: 0.5rem;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    border-radius: 4px;
    transition: color 0.2s, background-color 0.2s;
}
.btn-icon:hover {
    color: var(--primary);
    background-color: var(--light-alpha, rgba(168, 213, 186, 0.3));
}


/* Toggle Switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px; /* Slightly wider */
    height: 24px;
    flex-shrink: 0; /* Prevent shrinking */
}

.toggle-switch input { display: none; } /* Hide default checkbox */

.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: .3s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px; /* Smaller handle */
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

input:checked + .slider {
    background-color: var(--primary);
}

input:focus + .slider {
    box-shadow: 0 0 1px var(--primary); /* Focus indicator */
}

input:checked + .slider:before {
    transform: translateX(20px); /* Adjusted for wider switch */
}

/* Password Strength */
.password-strength {
    height: 6px;
    background: var(--border-color, #e9ecef);
    border-radius: 3px;
    margin-top: 0.5rem;
    overflow: hidden; /* Ensure meter stays within bounds */
}

.password-strength-meter {
    height: 100%;
    width: 0%;
    background-color: #dc3545; /* Default to weak */
    border-radius: 3px;
    transition: width 0.3s ease, background-color 0.3s ease;
}
/* Add specific colors for strength levels if JS updates them */
.password-strength-meter.weak { background-color: #dc3545; }
.password-strength-meter.medium { background-color: #ffc107; }
.password-strength-meter.strong { background-color: #198754; }


.password-strength-text {
    font-size: 0.8rem;
    color: var(--text-secondary, #6c757d);
    margin-top: 0.25rem;
    min-height: 1em; /* Prevent layout shift */
}

/* Form Actions & Buttons */
.form-actions {
    margin-top: 1rem; /* Space above buttons */
    display: flex;
    justify-content: flex-end; /* Align buttons to the right */
}

.btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    display: inline-flex; /* Align icon and text */
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.btn-primary {
    background-color: var(--primary);
    color: white;
}
.btn-primary:hover {
    background-color: var(--secondary);
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}
.btn-secondary:hover {
    background-color: #5a6268;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--primary);
    color: var(--primary);
}
.btn-outline:hover {
    background-color: var(--light-alpha, rgba(168, 213, 186, 0.2));
}

.btn-danger {
    background-color: #dc3545;
    color: white;
}
.btn-danger:hover {
    background-color: #c82333;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

/* Descriptions and Dividers */
p.description {
    font-size: 0.9rem;
    color: var(--text-secondary, #6c757d);
    margin: 0;
    line-height: 1.5;
}

hr.settings-divider {
    border: none;
    border-top: 1px solid var(--border-color, #e9ecef);
    margin: 1.5rem 0; /* More space around dividers */
}

/* Danger Zone */
.danger-zone label {
    color: #dc3545;
    font-weight: 600;
}

/* Feedback Alert */
.alert-message {
    padding: 1rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.8rem;
}
.alert-message.success {
    background-color: var(--alert-bg, #d1e7dd);
    color: var(--alert-text, #0f5132);
    border: 1px solid var(--alert-border, #badbcc);
}
.alert-message.error {
     background-color: var(--error-bg, #f8d7da);
    color: var(--error-text, #842029);
    border: 1px solid var(--error-border, #f5c2c7);
}
.alert-message i {
    font-size: 1.2rem;
}


/* Responsive Adjustments */
@media (max-width: 768px) {
    .profile-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    .form-group-toggle {
        flex-direction: column;
        align-items: stretch; /* Stretch items to full width */
        gap: 0.75rem; /* Reduce gap */
    }
    .form-group-toggle > div {
        margin-bottom: 0.5rem; /* Space between text and toggle */
    }
    .form-actions {
        justify-content: center; /* Center button on mobile */
    }
    .input-with-action {
        flex-wrap: wrap; /* Allow button to wrap below input if needed */
    }
     .settings-card .card-content {
        padding: 1rem;
    }
     .settings-card .card-header {
         padding: 0.8rem 1rem;
    }
}

/* Ensure modal styles are sufficient */
#confirmation-modal .upload-overlay-content {
    background: var(--card-bg, white);
    color: var(--text-primary, #333);
}
#confirmation-modal .upload-overlay-header h3 {
    color: var(--text-primary, #333);
}
#confirmation-modal .upload-overlay-header h3 i {
     color: #dc3545; /* Keep warning icon red */
}
#confirmation-modal .close-overlay {
    background: var(--secondary);
    color: white;
}
#confirmation-modal .close-overlay:hover {
    background: var(--primary);
}

        /* #########    Add this if you don't have a suitable .form-group style globally #########*/
#booking-modal .form-group {
    display: grid;
    grid-template-columns: 1fr; /* Simple stack layout */
    gap: 0.5rem; /* Smaller gap for modal */
    margin-bottom: 1rem;
    align-items: center;
}

#booking-modal .form-group label {
    font-weight: 500;
    color: var(--secondary);
    margin-bottom: 0.25rem; /* Space below label */
}

#booking-modal .form-input {
    padding: 0.75rem;
    border: 1px solid #E9ECEF;
    border-radius: 6px;
    width: 100%; /* Ensure inputs take full width */
    box-sizing: border-box; /* Include padding and border in width */
}
#booking-modal textarea.form-input {
    resize: vertical; /* Allow vertical resize */
}

#booking-modal .form-input:focus {
    border-color: var(--primary);
    outline: none;
}

.table {
  width: 100%;
  border-collapse: collapse;
  
}

.table th,
.table td {
  padding: 12px 15px;
}

.table thead {
  background-color: var(--primary);
  color: white;
}

.table tbody tr:nth-child(even) {
  background-color: var(--light);
}

.table tbody tr:nth-child(odd) {
  background-color: white;
}

.table th {
  font-weight: bold;
  text-align: left;
}

.table small {
  color: var(--accent);
}

.table tbody tr:hover {
  background-color: var(--alert);
  transition: background-color 0.3s;
}

          /* ######## HELP SECTION STYLES ######## */

#help-content { /* Add an ID to the main container if needed, or style directly */
    padding-top: 1rem; /* Add some space at the top */
}

.help-search-container {
    position: relative;
    margin-bottom: 2.5rem;
}

#help-search-input {
    padding-left: 2.8rem; /* Space for the icon */
    padding-right: 100px; /* Space for the button */
    border-radius: 25px; /* Rounded search bar */
    border: 1px solid #ced4da;
    height: 50px;
    font-size: 1rem;
}
#help-search-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(27, 94, 58, 0.2); /* Focus ring */
}


.help-search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-size: 1.2rem;
}

#help-search-btn {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    border-radius: 20px; /* Match input rounding */
    padding: 0.5rem 1.2rem;
    background-color: var(--primary);
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.2s ease;
}
#help-search-btn:hover {
    background-color: var(--secondary);
}

.help-section-card {
    margin-bottom: 2rem;
    border-left: 4px solid var(--accent);
    padding-left: 1.5rem;
    background-color: white; /* Ensure card background */
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.help-section-card h3 {
    color: var(--primary);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    font-size: 1.3rem;
}
.help-section-card h3 i {
    color: var(--primary);
    font-size: 1.4rem; /* Slightly larger icons in headings */
}


/* FAQ Styling */
.faq-section .faq-category {
    margin-bottom: 1.5rem;
}
.faq-section h4 {
    color: var(--secondary);
    margin-bottom: 1rem;
    font-weight: 600;
    border-bottom: 1px solid #eee;
    padding-bottom: 0.5rem;
}

.faq-item {
    border: 1px solid #e9ecef;
    border-radius: 5px;
    margin-bottom: 0.75rem;
    background-color: #fff;
    transition: box-shadow 0.2s ease;
}
.faq-item:hover {
     box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}


.faq-item summary {
    padding: 1rem 1.5rem;
    cursor: pointer;
    font-weight: 500;
    color: var(--secondary);
    list-style: none; /* Remove default marker */
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s ease;
}
.faq-item summary:hover {
    background-color: #f8f9fa;
}


.faq-item summary::-webkit-details-marker { display: none; } /* Chrome/Safari */
.faq-item summary::marker { display: none; } /* Firefox */

.faq-item summary::after { /* Custom toggle icon */
    content: '+';
    font-size: 1.4rem;
    font-weight: bold;
    color: var(--accent);
    transition: transform 0.2s ease;
}

.faq-item[open] summary {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
}

.faq-item[open] summary::after {
    content: ''; /* Minus sign */
    transform: rotate(180deg);
}

.faq-answer {
    padding: 1rem 1.5rem;
    background-color: #fdfdff; /* Slightly different background */
    color: #495057;
    border-top: 1px solid #e9ecef;
    line-height: 1.6;
}
.faq-answer p:last-child {
    margin-bottom: 0;
}

#no-faq-results {
    display: none; /* Hidden by default */
    text-align: center;
    padding: 1.5rem;
    color: #6c757d;
    font-style: italic;
}


/* Contact Section Styling */
.contact-methods {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive grid */
    gap: 1.5rem;
    margin-top: 1rem;
}

.contact-method {
    background-color: #f8f9fa;
    padding: 1.2rem;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    display: flex;
    flex-direction: column; /* Stack icon/title and details */
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.contact-method:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}


.contact-method-header {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 0.8rem;
}

.contact-method-header i {
    font-size: 1.5rem;
    color: var(--primary);
    width: 30px; /* Fixed width for alignment */
    text-align: center;
}

.contact-method-header span {
    font-weight: 600;
    color: var(--secondary);
    font-size: 1.1rem;
}

.contact-details {
    font-size: 0.95rem;
    color: #495057;
    padding-left: calc(30px + 0.8rem); /* Align details with text */
}
.contact-details a {
    color: var(--primary);
    text-decoration: none;
}
.contact-details a:hover {
    text-decoration: underline;
}
.contact-details small {
    display: block;
    margin-top: 0.3rem;
    color: #6c757d;
}


/* Resource/Guide/Support List Styling */
.help-list {
    list-style: none;
    padding-left: 0;
    margin-top: 1rem;
}
.help-list li {
    margin-bottom: 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.7rem;
}
.help-list li i {
    color: var(--accent);
    width: 20px; /* Align icons */
    text-align: center;
}

.help-list li a {
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
}
.help-list li a:hover {
    text-decoration: underline;
}
.help-list li span { /* For non-link items */
     color: #495057;
}

/* Emergency Card Styling */
.emergency-card {
    border-left: 6px solid #dc3545; /* Stronger red border */
    background-color: #f8d7da; /* Light red background */
    padding: 1.5rem 2rem;
    border-radius: 8px;
    margin-top: 2.5rem;
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.15);
}
.emergency-card h3 {
    color: #721c24; /* Darker red for text */
    font-size: 1.4rem;
    margin-bottom: 1rem;
}
.emergency-card h3 i {
     color: #721c24;
}
.emergency-card p {
    color: #721c24;
    line-height: 1.6;
}
.emergency-card strong {
    font-weight: 700;
}
.emergency-card .emergency-instruction {
    font-size: 1.15em;
    margin-bottom: 1rem;
}
.emergency-card .emergency-disclaimer {
    font-size: 0.9em;
    color: #842029; /* Slightly darker shade */
    margin-top: 1rem;
}


























.appointment-table, .prescription-table, .results-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.appointment-table th, .prescription-table th, .results-table th {
    background-color: var(--light);
    color: var(--primary);
    padding: 0.75rem;
    text-align: left;
}

.appointment-table td, .prescription-table td, .results-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #eee;
}


.file-input {
    margin: 1rem 0;
}

.condition-list, .surgery-list {
    list-style: none;
    padding: 0;
}

.condition-list li, .surgery-list li {
    padding: 0.75rem 0;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
}
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">Medical Assistance System</div>
        <div class="user-menu">
            <div class="dark-mode-toggle" id="dark-mode-toggle">
                <i class="fas fa-moon"></i>
            </div>
            <div class="notifications">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">3</span>
            </div>
            <div class="profile">
                <img src="{{ url_for('static', filename='profile.png') }}" alt="Profile" class="profile-pic">
                <div class="profile-dropdown">
                    <a href="#"  id="Profile-Settings-btn">Profile Settings</a>
                    <a href="#"  id="App-Settings-btn">App Settings</a>
                    <a href="#">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <nav class="sidebar">
        <div class="nav-item " id="dashboard-btn">
            <i class="fas fa-home"></i>
            Dashboard
        </div>
        <div class="nav-item" id="MedicalHistory-btn">
            <i class="fas fa-history"></i>
            Medical History
        </div>
        <div class="nav-item" id="Appointments-btn">
            <i class="fas fa-calendar-check"></i>
            Appointments
        </div>
        <div class="nav-item" id="Documents-btn">
            <i class="fas fa-file-alt"></i>
            Documents
        </div>
        <div class="nav-item" id="Prescriptions-btn">
            <i class="fas fa-prescription"></i>
            Prescriptions
        </div>
        <div class="nav-item" id="TestResults-btn">
            <i class="fas fa-file-medical"></i>
            Test Results
        </div>
        <div class="nav-item" id="ProfileSettings-btn">
            <i class="fas fa-user-cog"></i>
            Profile Settings
        </div>
        <div class="nav-item" id="ChatHistory-btn">
            <i class="fas fa-comments"></i>
            Chat
        </div>
        <div class="nav-item" id="help-btn">
            <i class="fas fa-question-circle"></i>
            Help
        </div>
        <div class="nav-item" id="Chatting" style="visibility: hidden;"></div>
    </nav>
    
    <main class="main-content">
        <!-- all the main area contents are rendered in script JS, so no need here.-->
    </main>

    <div class="chatbot-icon" id="voice-mode-btn">
        <i class="fas fa-comment-medical"></i>
    </div>


        <!-- Add voice mode overlay from test1.html -->
        <!-- Updated Voice Mode Overlay with New Animation -->
    <div id="voice-mode-overlay" class="upload-overlay">
        <div class="voice-overlay-container">
        <!-- New State Label -->
        <div class="state-label" id="voiceStateLabel">Listening</div>
        
        <!-- New Animation Wrapper -->
        <div class="animation-wrapper">
            <!-- Listening Animation -->
            <div class="listening-animation" id="listeningAnimation">
            <div class="listening-water-drop water-drop-base">
                <div class="color-blob listening-blob-1"></div>
                <div class="color-blob listening-blob-2"></div>
                <div class="color-blob listening-blob-3"></div>
                <div class="highlight"></div>
            </div>
            </div>
            <!-- Processing Animation -->
            <div class="processing-animation" id="processingAnimation">
            <div class="processing-water-drop water-drop-base">
                <div class="color-blob processing-blob-1"></div>
                <div class="color-blob processing-blob-2"></div>
                <div class="color-blob processing-blob-3"></div>
                <div class="highlight"></div>
                <div class="dna-helix" id="dnaHelix">
                <!-- DNA strands will be added dynamically -->
                </div>
            </div>
            </div>
            <!-- Speaking Animation -->
            <div class="speaking-animation" id="speakingAnimation">
            <div class="speaking-water-drop water-drop-base">
                <div class="color-blob speaking-blob-1"></div>
                <div class="color-blob speaking-blob-2"></div>
                <div class="color-blob speaking-blob-3"></div>
                <div class="highlight"></div>
                <div class="waveform" id="waveform">
                <!-- Waveform bars will be added dynamically -->
                </div>
                <div class="heartbeat-line">
                <svg height="20" width="80">
                    <path d="M0,10 L10,10 L15,2 L20,18 L25,0 L30,10 L70,10"
                        stroke="white" stroke-width="2" fill="none" stroke-linecap="round"
                        style="stroke-dasharray: 100; stroke-dashoffset: 100; animation: dash 1.5s ease-in-out infinite;"></path>
                </svg>
                </div>
            </div>
            </div>
        </div>
    
        <!-- Voice Controls -->
        <div class="voice-controls">
            <button id="finish-speaking-btn" class="glow-on-hover">
            <span class="btn-pulse"></span>
            Finish &amp; Process
            </button>
            <button id="cancel-voice-mode-btn" class="glow-on-hover red">
            <span class="btn-pulse"></span>
            Cancel
            </button>
        </div>
        </div>
    </div>


    <!-- Text Upload overlay -->
    <div id="text-upload-overlay" class="upload-overlay">
        <div class="upload-overlay-content">
            <div class="upload-overlay-header">
                <h3><img src="{{ url_for('static', filename='text-overlay.png') }}" alt="text upload">Upload Text Document</h3>
                <button class="close-overlay">&times;</button>
            </div>
            <form class="upload-form" data-type="text">
                <div class="file-input-container">
                    <input type="file" accept=".txt" required>
                    <div class="file-input-content">
                        <svg class="file-input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <div class="file-input-text">Drag and drop your text file here</div>
                        <div class="file-input-hint">or click to browse</div>
                    </div>
                </div>
                <div class="file-preview">
                    <svg class="file-preview-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <div class="file-preview-info">
                        <div class="file-preview-name"></div>
                        <div class="file-preview-size"></div>
                    </div>
                </div>
                <button type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg>
                    Upload File
                </button>
                <div class="upload-status"></div>
                <div class="loading">Processing document...</div>
            </form>
        </div>
    </div>


    <!-- Prescription Image Upload overlay -->
<div id="prescription-upload-overlay" class="upload-overlay overlay-textimage"> <!-- Added overlay-textimage for consistent background -->
    <div class="upload-overlay-content">
        <div class="upload-overlay-header">
            <h3><i class="fas fa-image" style="color: var(--primary);"></i> Upload Prescription Image</h3> <!-- Updated icon and title -->
            <button class="close-overlay" data-target="#prescription-upload-overlay"></button> <!-- Data target added -->
        </div>
        <!-- IMPORTANT: data-type is set to "prescription" -->
        <form class="upload-form" data-type="prescription">
            <div class="file-input-container">
                <!-- Changed accept attribute to image types -->
                <input type="file" accept="image/jpeg, image/png, image/webp, image/jpg" required>
                <div class="file-input-content">
                     <!-- Changed icon to image -->
                    <svg class="file-input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                    </svg>
                    <div class="file-input-text">Drag and drop your prescription image</div> <!-- Updated text -->
                    <div class="file-input-hint">(.jpg, .png, .webp) or click to browse</div> <!-- Updated hint -->
                </div>
            </div>
            <div class="file-preview"> <!-- Keep preview section -->
                <svg class="file-preview-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                   <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                </svg>
                <div class="file-preview-info">
                    <div class="file-preview-name"></div>
                    <div class="file-preview-size"></div>
                </div>
            </div>
            <button type="submit"> <!-- Keep submit button -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                </svg>
                Upload Prescription Image <!-- Updated button text -->
            </button>
            <div class="upload-status"></div>
            <div class="loading">Processing image...</div> <!-- Updated loading text -->
        </form>
    </div>
</div>

        <!-- Booking Appointment Modal -->
        <div id="booking-modal" class="upload-overlay" style="display: none;">
            <div class="upload-overlay-content">
                <div class="upload-overlay-header">
                    <h3><i class="fas fa-calendar-plus" style="color: var(--primary);"></i> Book New Appointment</h3>
                    <button class="close-overlay" data-target="#booking-modal"></button>
                </div>
                <form id="booking-form" class="upload-form">
    
                    <div class="form-group"> 
                        <label for="patient-name">Patient Name:</label>
                        <input type="text" id="patient-name" name="patient_name" class="form-input" required value="Iampisto">
                    </div>
    
                    <div class="form-group">
                        <label for="doctor-name">Doctor Name:</label>
                        <input type="text" id="doctor-name" name="doctor_name" class="form-input" required placeholder="e.g., Dr. Smith">
                    </div>
    
                    <div class="form-group">
                        <label for="appointment-type">Appointment Type:</label>
                        <input type="text" id="appointment-type" name="appointment_type" class="form-input" placeholder="e.g., Check-up, Follow-up">
                    </div>
    
                    <div class="form-group">
                        <label for="appointment-date">Date:</label>
                        <input type="date" id="appointment-date" name="appointment_date" class="form-input" required>
                    </div>
    
                    <div class="form-group">
                        <label for="appointment-time">Time:</label>
                        <input type="time" id="appointment-time" name="appointment_time" class="form-input" required>
                    </div>
    
                    <div class="form-group">
                        <label for="appointment-notes">Notes (Optional):</label>
                        <textarea id="appointment-notes" name="notes" class="form-input" rows="3"></textarea>
                    </div>
    
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="fas fa-check"></i> Confirm Booking
                    </button>
    
                    <div class="upload-status" id="booking-status"></div> 
                    <div class="loading" id="booking-loading" style="display: none;">Booking...</div>
    
                </form>
            </div>
        </div>


        <!-- Reschedule Appointment Modal -->
<div id="reschedule-modal" class="upload-overlay" style="display: none;">
    <div class="upload-overlay-content">
        <div class="upload-overlay-header">
            <h3><i class="fas fa-calendar-edit" style="color: var(--primary);"></i> Reschedule Appointment</h3>
            <button class="close-overlay" data-target="#reschedule-modal"></button>
        </div>
        <div id="reschedule-info" style="margin-bottom: 1rem; padding: 0.5rem; background-color: var(--light); border-radius: 5px; color: var(--primary);">
            Rescheduling: Loading details...
        </div>

        <form id="reschedule-form" class="upload-form">
            <input type="hidden" id="reschedule-appointment-id" name="appointment_id">

            <div class="form-group">
                <label for="reschedule-date">New Date:</label>
                <input type="date" id="reschedule-date" name="appointment_date" class="form-input" required>
            </div>

            <div class="form-group">
                <label for="reschedule-time">New Time:</label>
                <input type="time" id="reschedule-time" name="appointment_time" class="form-input" required>
            </div>


            <div class="form-group">
                <label for="reschedule-notes">Reason (Optional):</label>
                <textarea id="reschedule-notes" name="notes" class="form-input" rows="2"></textarea>
            </div>
 

            <button type="submit" class="btn-primary" style="width: 100%;">
                <i class="fas fa-check"></i> Confirm Reschedule
            </button>

            <div class="upload-status" id="reschedule-status"></div>
            <div class="loading" id="reschedule-loading" style="display: none;">Saving...</div>

        </form>
    </div>
</div>

    <script src="{{ url_for('static', filename='js/dark-mode.js') }}"></script>
    <script>
        $(document).ready(function() {

            // Get all nav items
            const navItems = document.querySelectorAll('.nav-item');

            // Create content sections for each navigation item
            const contentSections = {
                'dashboard-btn': `
                    <div class="greeting-section">
                        <h1 class="time-based-greeting" id="greetingText"></h1>
                        <p class="motivational-quote" id="motivationText"></p>
                    </div>
                    
                    <div class="card-grid">
                        <div class="card">
                            <h3><i class="fas fa-calendar-alt"></i> Appointments</h3>
                            <div class="appointment-content">
                                <p>Next appointment: <span id="nextAppointment">Loading...</span></p>
                                <br>
                                <a href="#" class="view-link" id="view-all-appointments-btn">View All</a>
                            </div>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-pills"></i> Medications</h3>
                            <ul class="medication-list" id="dashboard-medication-list">
                                <li>Loading medications...</li>
                            </ul><br>
                            <a href="#" class="view-link" id="view-all-prescriptions-btn" style="margin-left: 10px;">View All</a>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-file-medical-alt"></i> Test Results</h3>
                            <div id="dashboard-test-results-glimpse">
                                <p>Loading recent results...</p>
                            </div>
                            <br>
                            <a href="#" class="view-link" id="view-all-test-results-btn">View All Results</a>
                        </div>

                        <div class="card">
                            <h3><i class="fas fa-heartbeat"></i> Vital Trends</h3>
                            <div class="vital-chart">
                                <div>
                                    <label for="vital-date">Date:</label>
                                    <input type="date" id="vital-date" name="vital-date">

                                    <label for="vital-type">Vital Type:</label>
                                    <select id="vital-type" name="vital-type">
                                        <option value="heart_rate">Heart Rate</option>
                                        <option value="blood_pressure">Blood Pressure</option>
                                    </select>

                                    <label for="vital-value">Value:</label>
                                    <input type="number" id="vital-value" name="vital-value">

                                    <button id="add-vital-btn">Add Vital</button>
                                </div>
                                <button id="show-trends-btn">Show Trends</button>
                                <table id="vitals-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Vital Type</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Vital data will be added here -->
                                    </tbody>
                                </table>
                                <canvas id="vitalChart"></canvas>
                            </div>
                        </div>
                    </div>
                `,
                'MedicalHistory-btn': `
                    <h2><i class="fas fa-history"></i> Medical History</h2>
                    <div class="card">
                    <h3>Medical Conditions</h3>
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Condition</th>
                            <th>Details</th>
                        </tr>
                        </thead>
                        <tbody id="medical-history-table-body"></tbody>
                    </table>
                    </div>
                `,
                'Appointments-btn': `
                    <h2><i class="fas fa-calendar-check"></i> Appointments</h2>
            
            <!-- Upcoming Appointments -->
            <div class="card">
                <h3>Upcoming Appointments</h3>
                <table class="appointment-table" id="upcoming-appointments-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Doctor</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="upcoming-appointments-body">
                        <!-- Upcoming appointments will be loaded here by JavaScript -->
                        <tr><td colspan="6" style="text-align:center;">Loading appointments...</td></tr>
                    </tbody>
                </table>
                <button class="btn-primary" id="book-new-appointment-btn" style="margin-top: 1rem;">Book New Appointment</button>
            </div>

            <!-- Past Appointments -->
            <div class="card" style="margin-top: 2rem;"> 
                <h3>Past Appointments</h3>
                <table class="appointment-table" id="past-appointments-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Doctor</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="past-appointments-body">
                        <!-- Past appointments will be loaded here by JavaScript -->
                         <tr><td colspan="5" style="text-align:center;">Loading appointments...</td></tr>
                    </tbody>
                </table>
            </div>
                `,
                'Documents-btn': `
                    <h2><i class="fas fa-file-alt"></i> Documents</h2>
                    <!-- Wrap buttons in a div for better spacing -->
                    <div style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.75rem;">
                        <!--<button class="btn-primary" id="upload-text-btn" style="flex-grow: 1; min-width: 180px;">
                            <i class="fas fa-file-alt"></i> Upload Text Doc
                        </button>--!>
                        <button class="btn-secondary" id="upload-prescription-btn" style="flex-grow: 1; min-width: 180px;">
                            <i class="fas fa-image"></i> Upload Prescription
                        </button>
                    </div>
                    <div class="card">
                        <h3>Uploaded Documents</h3>
                        <div id="documents-list" style="margin-top: 1rem;">
                            <!-- Document list will be loaded here -->
                            <p>Loading documents...</p>
                        </div>
                    </div>
                `,
                'Prescriptions-btn': `
                    <h2><i class="fas fa-prescription"></i> Prescriptions</h2>
                    <div class="card">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Drug</th>
                            <th>Details</th>
                        </tr>
                        </thead>
                        <tbody id="prescriptions-table-body"></tbody>
                    </table>
                    </div>
                `,
                'TestResults-btn': `
                    <h2><i class="fas fa-file-medical"></i> Test Results</h2>
                    <div class="card">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Test</th>
                            <th>Details</th>
                        </tr>
                        </thead>
                        <tbody id="test-results-table-body"></tbody>
                    </table>
                    </div>
                `,
                'ProfileSettings-btn': `
                    <h2><i class="fas fa-user-cog"></i> Profile & Settings</h2>
                    
                    <!-- Feedback Area -->
                    <div id="settings-feedback" class="alert-message" style="display: none; margin-bottom: 1.5rem;"></div>

                    <div class="settings-grid">
                        <!-- Profile Card -->
                        <div class="card settings-card">
                            <div class="card-header">
                                <i class="fas fa-user fa-fw"></i>
                                <h3>Personal Information</h3>
                            </div>
                            <div class="card-content">
                                <div class="profile-header">
                                    <div class="avatar-wrapper">
                                        <img src="{{ url_for('static', filename='profile.png') }}" alt="Profile Avatar" class="profile-img" id="profile-avatar-img">
                                        <label for="avatar-upload-input" class="upload-btn-overlay" title="Change avatar">
                                            <i class="fas fa-camera"></i>
                                            <span>Change</span>
                                        </label>
                                        <input type="file" id="avatar-upload-input" accept="image/*" style="display: none;">
                                    </div>
                                    <div class="user-identity">
                                        <h4 id="profile-user-name-display">Iampisto</h4>
                                        <span class="member-since">Member since: May 2024</span>
                                    </div>
                                </div>

                                <form id="profile-info-form">
                                    <div class="form-group-inline">
                                        <label for="profile-fullname">Full Name</label>
                                        <input type="text" id="profile-fullname" class="form-input" value="Iampisto" required>
                                    </div>
                                     <div class="form-group-inline">
                                        <label for="profile-dob">Date of Birth</label>
                                        <input type="date" id="profile-dob" class="form-input" value="1975-05-15">
                                    </div>
                                     <div class="form-group-inline">
                                        <label for="profile-email">Email Address</label>
                                        <div class="input-with-action">
                                            <input type="email" id="profile-email" class="form-input" value="iampisto@example.com" readonly required>
                                            <button type="button" class="btn-icon btn-edit" data-target="profile-email" title="Edit Email"><i class="fas fa-pencil-alt"></i></button>
                                        </div>
                                    </div>
                                    <div class="form-group-inline">
                                        <label for="profile-phone">Phone Number</label>
                                         <div class="input-with-action">
                                            <input type="tel" id="profile-phone" class="form-input" value="(555) 123-4567" readonly>
                                             <button type="button" class="btn-icon btn-edit" data-target="profile-phone" title="Edit Phone"><i class="fas fa-pencil-alt"></i></button>
                                        </div>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Profile Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Security Card -->
                        <div class="card settings-card">
                             <div class="card-header">
                                <i class="fas fa-shield-alt fa-fw"></i>
                                <h3>Security Settings</h3>
                            </div>
                             <div class="card-content">
                                <form id="security-form">
                                    <h4>Change Password</h4>
                                    <div class="form-group">
                                        <label for="current-password">Current Password</label>
                                        <input type="password" id="current-password" class="form-input" placeholder="Enter your current password" autocomplete="current-password">
                                    </div>
                                    <div class="form-group">
                                        <label for="new-password">New Password</label>
                                        <input type="password" id="new-password" class="form-input" placeholder="Enter a strong new password" autocomplete="new-password">
                                        <div class="password-strength">
                                            <div class="password-strength-meter"></div>
                                        </div>
                                         <small class="password-strength-text">Enter a password</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="confirm-password">Confirm New Password</label>
                                        <input type="password" id="confirm-password" class="form-input" placeholder="Confirm your new password" autocomplete="new-password">
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-key"></i> Update Password</button>
                                    </div>
                                </form>

                                <hr class="settings-divider">

                                <h4>Account Security</h4>
                                <div class="form-group-toggle">
                                    <div>
                                        <label for="2fa-toggle">Two-Factor Authentication (2FA)</label>
                                         <small>Adds an extra layer of security to your account.</small>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="2fa-toggle">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                                <!-- Add more security options here if needed (e.g., trusted devices) -->
                            </div>
                        </div>

                        <!-- Notifications Card -->
                        <div class="card settings-card">
                            <div class="card-header">
                                <i class="fas fa-bell fa-fw"></i>
                                <h3>Notification Preferences</h3>
                            </div>
                            <div class="card-content">
                                <form id="notifications-form">
                                    <div class="form-group-toggle">
                                        <div>
                                            <label for="email-notifications">Email Notifications</label>
                                            <small>Receive appointment reminders and important updates via email.</small>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="email-notifications" checked>
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                     <div class="form-group-toggle">
                                        <div>
                                            <label for="sms-notifications">SMS Notifications</label>
                                            <small>Get urgent alerts and appointment reminders via text message.</small>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="sms-notifications">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                     <div class="form-group-toggle">
                                         <div>
                                            <label for="inapp-notifications">In-App Notifications</label>
                                            <small>Show notifications within the Medical Assistance System application.</small>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="inapp-notifications" checked>
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Notification Preferences</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Privacy Card -->
                        <div class="card settings-card">
                            <div class="card-header">
                                <i class="fas fa-user-secret fa-fw"></i>
                                <h3>Privacy & Data</h3>
                            </div>
                           <div class="card-content">
                                <div class="form-group-inline">
                                    <label>Export Your Data</label>
                                    <div class="input-with-action">
                                        <p class="description">Download a copy of your personal and medical data stored in the system.</p>
                                        <button type="button" class="btn btn-outline" id="export-data-btn"><i class="fas fa-download"></i> Export Data</button>
                                    </div>
                                </div>
                                <hr class="settings-divider">
                                 <div class="form-group-inline danger-zone">
                                     <label>Delete Account</label>
                                    <div class="input-with-action">
                                        <p class="description">Permanently delete your account and all associated data. This action cannot be undone.</p>
                                        <button type="button" class="btn btn-danger" id="delete-account-btn"><i class="fas fa-trash-alt"></i> Delete My Account</button>
                                    </div>
                                </div>
                           </div>
                        </div>
                    </div>

                    <!-- Confirmation Modal (Generic - can be reused) -->
                    <div id="confirmation-modal" class="upload-overlay" style="display: none;">
                        <div class="upload-overlay-content" style="max-width: 450px;">
                            <div class="upload-overlay-header">
                                <h3 id="confirmation-modal-title"><i class="fas fa-exclamation-triangle"></i> Confirm Action</h3>
                                <button class="close-overlay" data-target="#confirmation-modal"></button>
                            </div>
                            <p id="confirmation-modal-text" style="margin-bottom: 1.5rem; line-height: 1.6;"></p>
                            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                                <button class="btn btn-secondary" id="confirmation-modal-cancel-btn">Cancel</button>
                                <button class="btn btn-danger" id="confirmation-modal-confirm-btn">Confirm</button>
                             </div>
                        </div>
                    </div>
                `,
                'ChatHistory-btn': `
                    <h2><i class="fas fa-comments"></i> Chat History</h2>
                    <div class="card">
                        <button class="btn-primary" id="new-chat-btn" style="margin-bottom: 1rem;">New Chat</button>
                        <div class="chat-list" id="chat-list">
                            {% for chat in chats %}
                            <div class="chat-item" data-chat-id="{{ chat.id }}">
                                <div class="chat-header">
                                    <span class="chat-title"><strong>{{ chat.title }}</strong></span>
                                    <span class="chat-created_at">{{ chat.created_at.strftime('%b %d, %I.%M %p').upper() }}</span>
                                    <!-- Placeholder for the 20-30 word summary/description -->
                                    <div class="chat-summary" style="margin-top: 0.5rem;">
                                        <p style="color: #666; font-size: 0.9em; margin: 0;">
                                            {{ chat.summary }}
                                        </p>
                                    </div>
                                </div>
                                <div class="chat-actions">
                                    <button type="button" class="edit-chat-btn" data-chat-id="{{ chat.id }}"><i class="fas fa-edit"></i> Edit</button>
                                    <button type="button" class="delete-chat-btn" data-chat-id="{{ chat.id }}"><i class="fas fa-trash-alt"></i> Delete</button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                `,
                'help-btn':`
                    <div id="help-content">
                        <h2><i class="fas fa-question-circle"></i> Help & Support</h2>

                        <!-- 1. Search Functionality -->
                        <div class="help-search-container">
                            <i class="fas fa-search help-search-icon"></i>
                            <input type="search" id="help-search-input" class="form-input" placeholder="Search Help Topics (e.g., 'booking', 'password', 'billing')...">
                            <button id="help-search-btn">Search</button>
                        </div>

                        <div class="settings-grid">

                            <!-- 2. FAQs Section -->
                            <div class="card help-section-card faq-section">
                                <h3><i class="fas fa-list-ul"></i> Frequently Asked Questions</h3>
                                <div id="faq-list"> 
                                    <div class="faq-category">
                                        <h4>General Questions</h4>
                                        <details class="faq-item">
                                            <summary>How do I register for an account?</summary>
                                            <div class="faq-answer">
                                                <p>To register, click the 'Sign Up' button usually found on the login page. Follow the on-screen instructions, providing your basic personal information and verifying your email address to activate your account.</p>
                                            </div>
                                        </details>
                                        <details class="faq-item">
                                            <summary>How do I access the patient portal?</summary>
                                            <div class="faq-answer">
                                                <p>Once you are logged in, the main dashboard you see acts as your patient portal. Use the navigation menu on the left sidebar to access different sections like Appointments, Medical History, Documents, etc.</p>
                                            </div>
                                        </details>
                                         <details class="faq-item">
                                            <summary>Is my personal information secure?</summary>
                                            <div class="faq-answer">
                                                <p>Yes, we take data security very seriously. We use industry-standard encryption and security protocols to protect your personal and medical information. Please review our Privacy Policy for more details.</p>
                                            </div>
                                        </details>
                                    </div>
                                    <div class="faq-category">
                                        <h4>Appointments & Scheduling</h4>
                                        <details class="faq-item">
                                            <summary>How do I book a new appointment?</summary>
                                             <div class="faq-answer">
                                                <p>Navigate to the <a href="#" onclick="document.getElementById('Appointments-btn').click(); return false;">Appointments</a> section via the sidebar. Click the "Book New Appointment" button, then select the desired doctor, date, time, and provide any necessary details.</p>
                                            </div>
                                        </details>
                                        <details class="faq-item">
                                            <summary>How can I reschedule or cancel an appointment?</summary>
                                             <div class="faq-answer">
                                                <p>In the <a href="#" onclick="document.getElementById('Appointments-btn').click(); return false;">Appointments</a> section, find the upcoming appointment you need to modify. Click the "Reschedule" or "Cancel" button associated with that appointment and follow the confirmation steps.</p>
                                            </div>
                                        </details>
                                        <details class="faq-item">
                                            <summary>Will I get reminders for my appointments?</summary>
                                             <div class="faq-answer">
                                                <p>Yes, if you have enabled notifications in your <a href="#" onclick="document.getElementById('ProfileSettings-btn').click(); return false;">Profile Settings</a>, you may receive email or SMS reminders before your scheduled appointments.</p>
                                            </div>
                                        </details>
                                    </div>
                                     <div class="faq-category">
                                        <h4>Technical & Account</h4>
                                        <details class="faq-item">
                                            <summary>I forgot my password. How can I reset it?</summary>
                                             <div class="faq-answer">
                                                <p>On the login page, click the "Forgot Password?" link. Enter the email address associated with your account, and you will receive instructions on how to reset your password.</p>
                                            </div>
                                        </details>
                                         <details class="faq-item">
                                            <summary>How do I update my profile information?</summary>
                                             <div class="faq-answer">
                                                <p>Go to the <a href="#" onclick="document.getElementById('ProfileSettings-btn').click(); return false;">Profile Settings</a> section from the sidebar or user menu. Here you can update your name, contact details, password, and notification preferences.</p>
                                            </div>
                                        </details>
                                         <details class="faq-item">
                                            <summary>The website isn't displaying correctly. What should I do?</summary>
                                             <div class="faq-answer">
                                                <p>Please ensure you are using a modern, up-to-date web browser (like Chrome, Firefox, Safari, or Edge). Try clearing your browser's cache and cookies. If the problem persists, contact our Technical Support using the details below.</p>
                                            </div>
                                        </details>
                                    </div>
                                    <div class="faq-category">
                                        <h4>Billing & Insurance</h4>
                                        <details class="faq-item">
                                            <summary>Which insurance plans do you accept?</summary>
                                            <div class="faq-answer">
                                                <p>Insurance coverage can change. For the most current list of accepted plans, please contact our Billing Department directly at <a href="tel:+1-555-010-0002">[+1-555-010-0002]</a> or via email at <a href="mailto:billing@medicalassist.example.com">[billing@medicalassist.example.com]</a>.</p>
                                            </div>
                                        </details>
                                         <details class="faq-item">
                                            <summary>Where can I find my billing statements?</summary>
                                             <div class="faq-answer">
                                                <p>Billing statements may be available within the portal (check Documents or a dedicated Billing section if available) or sent via mail/email. Contact the Billing Department for specific inquiries.</p>
                                            </div>
                                        </details>
                                    </div>
                                </div> 
                                <div id="no-faq-results">No matching FAQs found. Please try different keywords or contact support.</div>
                            </div>

                            <!-- 3. Contact Information -->
                            <div class="card help-section-card">
                                <h3><i class="fas fa-address-book"></i> Contact Us</h3>
                                <p>If you can't find your answer above, please reach out:</p>
                                <div class="contact-methods">
                                    <div class="contact-method">
                                        <div class="contact-method-header">
                                            <i class="fas fa-phone"></i>
                                            <span>General Inquiries</span>
                                        </div>
                                        <div class="contact-details">
                                            <a href="tel:+1-555-010-0001">[+1-555-010-0001]</a>
                                            <small>Mon-Fri, 9am-5pm [Your Timezone]</small>
                                        </div>
                                    </div>
                                     <div class="contact-method">
                                        <div class="contact-method-header">
                                            <i class="fas fa-file-invoice-dollar"></i>
                                            <span>Billing Department</span>
                                        </div>
                                        <div class="contact-details">
                                            <a href="tel:+1-555-010-0002">[+1-555-010-0002]</a><br>
                                            <a href="mailto:billing@medicalassist.example.com">[billing@medicalassist.example.com]</a>
                                             <small>Mon-Fri, 9am-4:30pm [Your Timezone]</small>
                                        </div>
                                    </div>
                                     <div class="contact-method">
                                        <div class="contact-method-header">
                                            <i class="fas fa-laptop-code"></i>
                                            <span>Technical Support</span>
                                        </div>
                                        <div class="contact-details">
                                             <a href="mailto:support@medicalassist.example.com">[support@medicalassist.example.com]</a>
                                             <small>Allow up to 24hrs for response</small>
                                        </div>
                                    </div>
                                     <div class="contact-method">
                                        <div class="contact-method-header">
                                            <i class="fas fa-comments"></i>
                                            <span>Live Chat</span>
                                        </div>
                                        <div class="contact-details">
                                             <button class="btn-secondary" style="padding: 0.3rem 0.8rem; font-size: 0.9em;" onclick="alert('Live Chat Not Implemented Yet')">Start Chat Session</button>
                                             <small>Available during support hours</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. Technical Support / Guides / Resources Grouped -->
                             <div class="card help-section-card">
                                <h3><i class="fas fa-book-open"></i> Guides & Resources</h3>
                                <ul class="help-list">
                                    <li><i class="fas fa-route"></i> <a href="#" onclick="document.getElementById('Appointments-btn').click(); return false;">Guide: Booking & Managing Appointments</a></li>
                                    <li><i class="fas fa-file-upload"></i> <a href="#" onclick="document.getElementById('Documents-btn').click(); return false;">Guide: Uploading & Managing Documents</a></li>
                                    <li><i class="fas fa-user-edit"></i> <a href="#" onclick="document.getElementById('ProfileSettings-btn').click(); return false;">Guide: Updating Your Profile</a></li>
                                    <li><i class="fas fa-key"></i> <a href="#" onclick="alert('Link to Password Reset Guide'); return false;">How to Reset Your Password</a></li>
                                    <li><i class="fas fa-desktop"></i> <a href="#" onclick="alert('Link to Browser Compatibility Info'); return false;">Browser Compatibility Information</a></li>
                                    <li style="margin-top: 1.5rem;"><i class="fas fa-book-medical"></i> <span>Trusted External Resources:</span></li>
                                    <li style="padding-left: 27px;"><i class="fas fa-external-link-alt" style="font-size: 0.8em;"></i> <a href="https://www.cdc.gov" target="_blank" rel="noopener noreferrer">CDC (Centers for Disease Control)</a></li>
                                    <li style="padding-left: 27px;"><i class="fas fa-external-link-alt" style="font-size: 0.8em;"></i> <a href="https://medlineplus.gov" target="_blank" rel="noopener noreferrer">MedlinePlus (Health Information)</a></li>
                                </ul>
                                <p style="margin-top: 1.5rem;"><small><i>Disclaimer: External resources provide general information and do not substitute professional medical advice.</i></small></p>
                             </div>

                             <!-- 5. Accessibility Information -->
                            <div class="card help-section-card">
                               <h3><i class="fas fa-universal-access"></i> Accessibility</h3>
                               <p>We are committed to providing an accessible experience. Our platform aims for WCAG 2.1 AA compliance.</p>
                               <ul class="help-list">
                                   <li><i class="fas fa-keyboard"></i> <span>Full keyboard navigation support.</span></li>
                                   <li><i class="fas fa-low-vision"></i> <span>Screen reader compatibility.</span></li>
                                   <li><i class="fas fa-adjust"></i> <span>Sufficient color contrast (enhanced by Dark Mode option).</span></li>
                               </ul>
                               <p>Encountering issues? Please <a href="#" onclick="alert('Direct link/modal for reporting accessibility issues'); return false;">report an accessibility barrier</a> or contact support. View our full <a href="#" onclick="alert('Link to full Accessibility Statement page'); return false;">Accessibility Statement</a>.</p>
                            </div>

                        </div>

                        <!-- 6. Emergency Information -->
                        <div class="card emergency-card">
                            <h3><i class="fas fa-exclamation-triangle"></i> Medical Emergencies</h3>
                            <p class="emergency-instruction"><strong>If you are experiencing a life-threatening medical emergency, dial your local emergency number 108 for Ambulance, 100 for Police immediately or go to the nearest emergency room.</strong></p>
                            <p class="emergency-disclaimer">This help section and our regular support channels are <strong>not</strong> equipped to handle urgent medical situations.</p>
                        </div>
                    </div>
                `,
                'Chatting':`
                    <div class= "chatting-header-firstline">
                        <button class="button-back-to-chat-history"><i class="fas fa-arrow-left"></i> Back</button>
                        <button class="add-chat-description-btn"><i class="fas fa-plus"></i> Add Description</button>
                    </div>
                    <h2><i class="fas fa-comment"></i> MedBuddy chat</h2>
                    <div id="chat-container"></div>

                    <form id="message-form">
                        <textarea id="message-input" placeholder="Ask me anything about any medical queries or your prescriptions..." required></textarea>
                        <button type="submit">
                            <span class="button-text">Send</span>
                            <span class="button-icon"></span>
                        </button>
                    </form>
                `
            };

            // Function to show content based on nav item ID
            function showContent(navItemId) {
                const mainContent = document.querySelector('.main-content');
                
                // Get the content for the selected nav item
                const content = contentSections[navItemId] || `<h2>Coming Soon</h2><div class="card"><p>This section is under development.</p></div>`;
                
                // Update the main content
                mainContent.innerHTML = content;
                
                // Reinitialize time-based greeting if we're on the dashboard
                if (navItemId === 'dashboard-btn') {
                    updateGreeting();

                    // --- Fetch and Display Appointment Glimpse ---
                    fetch('/appointments?limit=1&status=upcoming') // Adjust API if needed, fetch only 1 upcoming
                        .then(response => response.ok ? response.json() : Promise.reject('Failed to load'))
                        .then(data => {
                            const nextApptSpan = document.getElementById('nextAppointment');
                            if (data && data.upcoming && data.upcoming.length > 0) {
                                const nextAppt = data.upcoming[0]; // Assuming sorted by date
                                const apptDateTime = new Date(nextAppt.datetime);
                                const dateStr = apptDateTime.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
                                const timeStr = apptDateTime.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                                nextApptSpan.textContent = `${nextAppt.type || 'Appointment'} with ${nextAppt.doctor || 'Doctor'} on ${dateStr} at ${timeStr}`;
                            } else {
                                nextApptSpan.textContent = 'No upcoming appointments';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching next appointment:', error);
                            document.getElementById('nextAppointment').textContent = 'Error loading';
                        });


                    // --- Fetch and Display Medication Glimpse ---
                    const medList = document.getElementById('dashboard-medication-list');
                    fetch('/api/prescriptions') // Fetch full list (frontend slices)
                        .then(response => response.ok ? response.json() : Promise.reject('Failed to load'))
                        .then(data => {
                            medList.innerHTML = ''; // Clear loading message
                            if (data && data.length > 0) {
                                const glimpseData = data.slice(0, 3); // Show top 3
                                glimpseData.forEach(med => {
                                    const li = document.createElement('li');
                                    li.className = 'medication-item';
                                    li.innerHTML = `
                                        <span>${med.drug_name} ${med.dosage || ''}</span>
                                        <span>${med.frequency || ''}</span>
                                    `;
                                    medList.appendChild(li);
                                });
                                if (data.length > 3) {
                                    // Optional: Add a "..." indicator if more exist
                                    const liMore = document.createElement('li');
                                    liMore.style.textAlign = 'center';
                                    liMore.style.color = '#888';
                                    liMore.textContent = '...';
                                    medList.appendChild(liMore);
                                }
                            } else {
                                medList.innerHTML = '<li>No current medications found.</li>';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching prescriptions:', error);
                            medList.innerHTML = '<li>Error loading medications.</li>';
                        });


                    // --- Fetch and Display Test Results Glimpse ---
                    const resultsGlimpseDiv = document.getElementById('dashboard-test-results-glimpse');
                    fetch('/api/test-results') // Fetch full list (frontend sorts and slices)
                        .then(response => response.ok ? response.json() : Promise.reject('Failed to load'))
                        .then(data => {
                            resultsGlimpseDiv.innerHTML = ''; // Clear loading message
                            if (data && data.length > 0) {
                                // Sort by date, newest first (assuming 'date' field exists)
                                data.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                                const glimpseData = data.slice(0, 3); // Show top 3 most recent

                                glimpseData.forEach(result => {
                                    const p = document.createElement('p');
                                    const resultDate = result.date ? new Date(result.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric'}) : 'No date';
                                    p.innerHTML = `
                                        <strong>${result.test_name || 'Unknown Test'}:</strong>
                                        ${result.result_value || 'N/A'} ${result.units || ''}
                                        <small>(${resultDate})</small>
                                    `;
                                    // Optional: Add indicator for abnormal results if data available
                                    // if (result.is_abnormal) { p.style.color = 'orange'; }
                                    resultsGlimpseDiv.appendChild(p);
                                });
                                 if (data.length > 3) {
                                    const pMore = document.createElement('p');
                                    pMore.style.textAlign = 'center';
                                    pMore.style.color = '#888';
                                    pMore.textContent = '...';
                                    resultsGlimpseDiv.appendChild(pMore);
                                }
                            } else {
                                resultsGlimpseDiv.innerHTML = '<p>No recent test results found.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching test results:', error);
                            resultsGlimpseDiv.innerHTML = '<p>Error loading test results.</p>';
                        });

                    setTimeout(() => {
                        try {
                        // Fetch vital trends and initialize the chart
                        fetch('/vitals/trends')
                            .then(response => response.json())
                            .then(data => {
                                if (data.vitals && data.vitals.length > 0) {
                                    // Prepare data for the chart (same logic as in show-trends-btn click handler)
                                    const chartData = {
                                        labels: [],
                                        datasets: []
                                    };
                        
                                    // Group data by date AND vital type
                                    const groupedData = {};
                                    data.vitals.forEach(vital => {
                                        const date = vital.date;
                                        const vitalType = vital.vital_type;
                                        if (!groupedData[date]) {
                                            groupedData[date] = {};
                                        }
                                        groupedData[date][vitalType] = vital.value;
                                    });
                        
                                    // Create unique labels and datasets
                                    chartData.labels = Object.keys(groupedData).sort(); // Sort dates
                        
                                    const datasetsMap = {}; // To track datasets by vital type
                                    const vitalTypes = ['heart_rate', 'blood_pressure']; // Define all possible vital types
                        
                                    for (const date of chartData.labels) {
                                        for (const vitalType of vitalTypes) {
                                            if (!datasetsMap[vitalType]) {
                                                let borderColor = '#ccc';
                                                if (vitalType === 'heart_rate') {
                                                    borderColor = '#e74c3c';
                                                } else if (vitalType === 'blood_pressure') {
                                                    borderColor = '#3498db';
                                                }
                                                datasetsMap[vitalType] = {
                                                    label: vitalType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                                    data: [],
                                                    borderColor: borderColor,
                                                    tension: 0.3,
                                                    pointRadius: 5,
                                                    pointHoverRadius: 7
                                                };
                                                chartData.datasets.push(datasetsMap[vitalType]);
                                            }
                        
                                            // Add data point or null if missing for the current date and vital type
                                            if (groupedData[date] && groupedData[date][vitalType] !== undefined) {
                                                datasetsMap[vitalType].data.push(groupedData[date][vitalType]);
                                            } else {
                                                datasetsMap[vitalType].data.push(null); // Fill with null if no data
                                            }
                                        }
                                    }
                        
                                    initVitalChart(chartData);
                                } else {
                                    initVitalChart({ labels: [], datasets: [] });
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching vital trends:', error);
                                initVitalChart({ labels: [], datasets: [] });
                            });
                        } catch (error) {
                            console.error('Error in vital trends processing:', error);
                        }
                    }, 0);
                } 
                if (navItemId === 'Documents-btn'){
                    loadDocuments();
                    function_for_documents();
                }
                if (navItemId === 'MedicalHistory-btn') {
                    loadMedicalHistory();
                }
                if (navItemId === 'Prescriptions-btn') {
                    loadPrescriptions();
                }
                if (navItemId === 'TestResults-btn') {
                    loadTestResults();
                }
                if (navItemId == 'ProfileSettings-btn') {
                    settings();
                }
                if (navItemId == 'Appointments-btn') {
                    function_for_appointments();
                }
                if (navItemId === 'Chatting') {
                    currentChatId = null;
                    $('#chat-container').empty();
                    if (!currentChatId) {
                        $('#chat-container').html('<p>Select or create a chat</p>');
                    }

                    const headerLogo = document.querySelector('.header .logo');
                    const chatHeader = document.querySelector('.main-content h2');

                    if (chatHeader) {
                        const observer = new IntersectionObserver((entries) => {
                            entries.forEach(entry => {
                                headerLogo.classList.add('hidden');
                                
                                setTimeout(() => {
                                    headerLogo.textContent = entry.isIntersecting
                                        ? 'Medical Assistance System'
                                        : 'MedBuddy Chat';
                                    
                                    headerLogo.classList.remove('hidden');
                                }, 200); // This matches the CSS transition time (0.5s)
                            });
                        }, { threshold: 0.1 });

                        observer.observe(chatHeader);
                    }
                }

                if (navItemId === 'help-btn') {
                    // ... (other potential code for the help section)

                    // --- HELP SECTION SEARCH FUNCTIONALITY ---
                    const searchInput = document.getElementById('help-search-input');
                    const searchButton = document.getElementById('help-search-btn');
                    const faqItems = document.querySelectorAll('#faq-list .faq-item'); // Target FAQ items
                    const faqCategories = document.querySelectorAll('#faq-list .faq-category'); // Target categories
                    const noResultsMessage = document.getElementById('no-faq-results');

                    function performSearch() {
                        const searchTerm = searchInput.value.toLowerCase().trim();
                        let resultsFound = false;

                        faqCategories.forEach(category => {
                            let categoryHasVisibleItem = false;
                            const itemsInCategory = category.querySelectorAll('.faq-item');

                            itemsInCategory.forEach(item => {
                                const summaryText = item.querySelector('summary').textContent.toLowerCase();
                                const answerElement = item.querySelector('.faq-answer');
                                const answerText = answerElement ? answerElement.textContent.toLowerCase() : '';

                                // Check if search term is in summary OR answer
                                if (summaryText.includes(searchTerm) || answerText.includes(searchTerm)) {
                                    item.style.display = ''; // Show item
                                    resultsFound = true;
                                    categoryHasVisibleItem = true;
                                } else {
                                    item.style.display = 'none'; // Hide item
                                }
                            });

                            // Hide category heading if no items within it match
                            if (categoryHasVisibleItem) {
                                category.style.display = '';
                            } else {
                                category.style.display = 'none';
                            }
                        });


                        // Show/hide the "no results" message
                        if (!resultsFound && searchTerm !== '') {
                            noResultsMessage.style.display = 'block';
                        } else {
                            noResultsMessage.style.display = 'none';
                        }

                         // If search is empty, show all categories and items
                        if (searchTerm === '') {
                             faqCategories.forEach(category => {
                                category.style.display = '';
                                category.querySelectorAll('.faq-item').forEach(item => {
                                    item.style.display = '';
                                });
                            });
                             noResultsMessage.style.display = 'none';
                        }
                    }

                    // Event listeners for search
                    searchInput.addEventListener('keyup', performSearch);
                    searchButton.addEventListener('click', performSearch);
                    // Also handle clearing the search input (optional but good UX)
                    searchInput.addEventListener('search', () => { // Handles the 'x' button in search inputs
                        if (searchInput.value === '') {
                            performSearch();
                        }
                    });
                    // --- END HELP SECTION SEARCH ---
                }
            }

            // Add click event listeners to each nav item
            navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        // Remove active class from all items
                        navItems.forEach(navItem => {
                            navItem.classList.remove('active');
                        });
                        
                        // Add active class to clicked item
                        this.classList.add('active');
                        
                        // Show the content for this nav item
                        showContent(this.id);
                    });
                });


            

            // --- Event Delegation for Dashboard's "ProfileSettings" Link ---
            $(document).on('click', '#Profile-Settings-btn', function(e) {
                e.preventDefault(); // Prevent the default link behavior (going to '#')
                console.log("profile seetings button clicked on the header");

                // Find the main Appointments button in the sidebar and trigger its click event
                $('#ProfileSettings-btn').click();
            });

            // --- Event Delegation for Dashboard's "App Settings" Link ---
            $(document).on('click', '#Profile-Settings-btn', function(e) {
                e.preventDefault(); // Prevent the default link behavior (going to '#')
                console.log("profile seetings button clicked on the header");

                // Find the main Appointments button in the sidebar and trigger its click event
                $('#ProfileSettings-btn').click();
            });



            /*###################  DASHBOARD SECTION  ####################  */

            // Function to update the greeting
            function updateGreeting() {
                const hour = new Date().getHours();
                const greeting = document.getElementById('greetingText');
                const quotes = [
                    "Take care of your body; it's the only place you have to live.",
                    "Your health is an investment, not an expense.",
                    "The greatest wealth is health.",
                    "Healing is a matter of time, but it is sometimes also a matter of opportunity.",
                    "Health is not valued until sickness comes.",
                    "Your body deserves the best.",
                    "Health is the greatest gift, contentment the greatest wealth.",
                    "Strive for progress, not perfection.",
                    "Nourish to flourish.",
                    "A healthy mind equals a healthy body.",
                    "Wellness is a journey, not a destination.",
                    "Invest in your health, and your future will thank you.",
                    "Dont wait for illness to teach you the value of health.",
                    "When you feel good, you do good.",
                    "True wellness begins with self-love.",
                    "Small habits create big health results.",
                    "Health is not something you buy, its something you build.",
                    "Good health is a form of wealth.",
                    "Your body will thank you for the care you give it.",
                    "Wellness is a lifestyle, not a one-time thing.",
                    "Take care of yourself so you can take care of others.",
                    "The body achieves what the mind believes.",
                    "Exercise is a celebration of what your body can do.",
                    "The best project you will ever work on is you.",
                    "Wellness is the key to a long and happy life.",
                    "Live a life that nourishes you.",
                    "A healthy lifestyle is a choice, not a sacrifice.",
                    "Strength doesn't come from what you can do, but from overcoming the things you once thought you couldnt.",
                    "A healthy outside starts with a healthy inside.",
                    "The first wealth is health.",
                    "Wellness is the art of maintaining balance in life.",
                    "Its not about being perfect, its about effort.",
                    "Your health is your responsibility.",
                    "Treat your body like it's the only one you'll ever have.",
                    "Self-care is not selfish, its essential.",
                    "Health isnt just about what youre eating, its also about what youre thinking and saying.",
                    "Your health is the foundation of everything.",
                    "Healing begins with self-awareness.",
                    "Success in health begins with small, consistent changes.",
                    "Take care of your body; it's the only place you truly live.",
                    "Health is not just about the body, but the mind as well.",
                    "A healthy body is the guest-chamber of the soul.",
                    "Balance is not something you find; its something you create.",
                    "Be stronger than your strongest excuse.",
                    "The greatest wealth is health.",
                    "Every day is a chance to be healthier.",
                    "The more you focus on your health, the more it will pay you back.",
                    "Treat your body as you would treat someone you love.",
                    "You dont have to be great to start, but you have to start to be great.",
                    "Health is not a goal, its a way of living.",
                    "Listen to your body; it knows what it needs.",
                    "The greatest medicine is teaching people how not to need it.",
                    "Your health is a reflection of the choices you make every day.",
                    "A healthy outside starts from the inside."
                ];
                
                if (greeting) {
                    if (hour < 12) {
                        greeting.textContent = 'Good Morning, Iampisto';
                    } else if (hour < 18) {
                        greeting.textContent = 'Good Afternoon, Iampisto';
                    } else {
                        greeting.textContent = 'Good Evening, Iampisto';
                    }
                }
                
                const motivationText = document.getElementById('motivationText');
                if (motivationText) {
                    motivationText.textContent = quotes[Math.floor(Math.random() * quotes.length)];
                }
            }

            

            // Set dashboard as active by default and show dashboard content
            document.getElementById('dashboard-btn').classList.add('active');
            showContent('dashboard-btn');

            // Initialize greeting on page load
            updateGreeting();

            // Toggle sidebar on mobile
            function toggleSidebar() {
                document.querySelector('.sidebar').classList.toggle('active');
            }

            // Chatbot toggle
            document.querySelector('.chatbot-icon').addEventListener('click', () => {
                document.querySelector('.chat-window').style.display =
                    document.querySelector('.chat-window').style.display === 'block' ? 'none' : 'block';
            });

            // Add this to your existing JavaScript
            let vitalChartInstance = null;

            function initVitalChart() {
                const ctx = document.getElementById('vitalChart');
                
                // Destroy existing instance if it exists
                if (vitalChartInstance) {
                    vitalChartInstance.destroy();
                }

                // Sample initial data
                const initialData = {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [
                        {
                            label: 'Heart Rate',
                            data: [72, 75, 73, 70, 74, 76, 72],
                            borderColor: '#e74c3c',
                            tension: 0.3,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        },
                        {
                            label: 'Blood Pressure',
                            data: [120, 122, 118, 119, 121, 123, 120],
                            borderColor: '#3498db',
                            tension: 0.3,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                };

                vitalChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: initialData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 20
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 60,
                                max: 140,
                                ticks: {
                                    stepSize: 20
                                }
                            }
                        }
                    }
                });
            }


            // Add this function to update the chart dynamically
            function updateVitalChart(newData) {
                if(vitalChartInstance) {
                    vitalChartInstance.data.labels = newData.labels || vitalChartInstance.data.labels;
                    vitalChartInstance.data.datasets.forEach((dataset, index) => {
                        dataset.data = newData.datasets[index].data || dataset.data;
                        dataset.label = newData.datasets[index].label || dataset.label;
                    });
                    vitalChartInstance.update();
                }
            }

            // Example usage of updating the chart:
            const newData = {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [
                    {
                        label: 'Heart Rate',
                        data: [74, 73, 75, 72]
                    },
                    {
                        label: 'Blood Pressure',
                        data: [118, 120, 121, 119]
                    }
                ]
            };

            // Call this whenever you need to update the chart
            updateVitalChart(newData);
            //updateVitalChart(newData); // REMOVE THIS - We'll update the chart from the API response

            // Add event listener for the "Add Vital" button
            document.getElementById('add-vital-btn').addEventListener('click', function() {
                const date = document.getElementById('vital-date').value;
                const vitalType = document.getElementById('vital-type').value;
                const value = document.getElementById('vital-value').value;

                if (!date || !vitalType || !value) {
                    alert('Please fill in all fields.');
                    return;
                }

                fetch('/vitals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ date, vital_type: vitalType, value })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);
                        // Optionally, clear the input fields
                        document.getElementById('vital-date').value = '';
                        document.getElementById('vital-type').value = '';
                        document.getElementById('vital-value').value = '';
                        // Refresh the trends after adding a new vital
                        document.getElementById('show-trends-btn').click();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred.');
                });
            });


            // Add event listener for the "Show Trends" button
            document.getElementById('show-trends-btn').addEventListener('click', function() {
                fetch('/vitals/trends')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('vitals-table').querySelector('tbody');
                    tableBody.innerHTML = ''; // Clear existing data

                    if (data.vitals && data.vitals.length > 0) {
                        data.vitals.forEach(vital => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${vital.date}</td>
                                <td>${vital.vital_type}</td>
                                <td>${vital.value}</td>
                                <td><button class="delete-vital-btn" data-vital-id="${vital.id}">Delete</button></td>
                            `;
                            tableBody.appendChild(row);
                        });

                        // Add event listener for delete buttons
                        tableBody.addEventListener('click', function(event) {
                            if (event.target.classList.contains('delete-vital-btn')) {
                                const vitalId = event.target.dataset.vitalId;
                                if (confirm('Are you sure you want to delete this vital data?')) {
                                    fetch(`/vitals/${vitalId}`, {
                                        method: 'DELETE'
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.message) {
                                            alert(data.message);
                                            // Remove the row from the table
                                            event.target.closest('tr').remove();
                                            // Refresh the trends after deleting
                                            document.getElementById('show-trends-btn').click();
                                        } else {
                                            alert('Error: ' + (data.error || 'Unknown error'));
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                        alert('An error occurred while deleting the vital data.');
                                    });
                                }
                            }
                        });

                        // Prepare data for the chart
                        const chartData = {
                            labels: data.vitals.map(vital => vital.date),
                            datasets: []
                        };

                        // Group data by vital type
                        const groupedData = {};
                        data.vitals.forEach(vital => {
                            if (!groupedData[vital.vital_type]) {
                                groupedData[vital.vital_type] = [];
                            }
                            groupedData[vital.vital_type].push(vital.value);
                        });

                        // Create datasets for each vital type
                        for (const vitalType in groupedData) {
                            let borderColor = '#ccc'; // Default color
                            if (vitalType === 'heart_rate') {
                                borderColor = '#e74c3c';
                            } else if (vitalType === 'blood_pressure') {
                                borderColor = '#3498db';
                            }    

                            chartData.datasets.push({
                                label: vitalType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), // Format label
                                data: groupedData[vitalType],
                                borderColor: borderColor,
                                tension: 0.3,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            });
                        }
                        updateVitalChart(chartData);

                    } else {
                        tableBody.innerHTML = '<tr><td colspan="3">No vital data found.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while fetching vital trends.');
                });
            });

            // Modified initVitalChart function to accept data
            function initVitalChart(data) {
                const ctx = document.getElementById('vitalChart');

                // Destroy existing instance if it exists
                if (vitalChartInstance) {
                    vitalChartInstance.destroy();
                }

                vitalChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 20
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                            }
                        }
                    }
                });
            }

            // --- Event Delegation for Dashboard's "View All Appointments" Link ---
            $(document).on('click', '#view-all-appointments-btn', function(e) {
                e.preventDefault(); // Prevent the default link behavior (going to '#')
                console.log("Dashboard 'View All Appointments' link clicked. Triggering Appointments section load.");

                // Find the main Appointments button in the sidebar and trigger its click event
                $('#Appointments-btn').click();
            });

            // --- Event Delegation for Dashboard's "View All prescriptions" Link ---
            $(document).on('click', '#view-all-prescriptions-btn', function(e) {
                e.preventDefault(); // Prevent the default link behavior (going to '#')
                console.log("Dashboard 'View All Appointments' link clicked. Triggering Appointments section load.");

                // Find the main Appointments button in the sidebar and trigger its click event
                $('#Prescriptions-btn').click();
            });

            // --- Event Delegation for Dashboard's "View All test-results" Link ---
            $(document).on('click', '#view-all-test-results-btn', function(e) {
                e.preventDefault(); // Prevent the default link behavior (going to '#')
                console.log("Dashboard 'View All Appointments' link clicked. Triggering Appointments section load.");

                // Find the main Appointments button in the sidebar and trigger its click event
                $('#TestResults-btn').click();
            });



           // ######################### TEXT DOCUMENT  #####################

            // Function to load and display documents
            function loadDocuments() {
                $.get('/documents', function(response) {
                    const documentsList = $('#documents-list');
                    documentsList.empty();
                    
                    response.documents.forEach(function(doc) {
                        const typeBadgeClass = doc.type === 'prescription' ? 
                            'document-type-prescription' : 'document-type-text';
                        
                        documentsList.append(`
                            <div class="document-item" data-doc-id="${doc.id}">
                                <div class="document-info">
                                    <i class="fas fa-file" style="color: var(--secondary)"></i>
                                    <span class="document-name">${doc.filename}</span>
                                    <span class="document-type-badge ${typeBadgeClass}">
                                        ${doc.type}
                                    </span>
                                    <div class="document-meta">
                                        Uploaded: ${doc.created_at}
                                    </div>
                                </div>
                                <button class="view-document-btn"><i class="fas fa-eye"></i> View</button>
                                <button class="delete-document-btn"><i class="fas fa-trash-alt"></i> Delete</button>
                            </div>
                        `);
                    });
                });
            }
        
            // Call loadDocuments initially
            loadDocuments();
            
        
            function function_for_documents(){
    // Use .off().on() to prevent multiple bindings if this function is called repeatedly
    $('#upload-text-btn').off('click').on('click', function() {
        // Clear previous status/file in text overlay before showing
        const form = $('#text-upload-overlay form');
        form[0].reset(); // Reset the form itself (clears file input)
        form.find('.file-preview').removeClass('active').find('.file-preview-name, .file-preview-size').text(''); // Hide/clear preview
        form.find('.upload-status').text('').removeClass('upload-success upload-error'); // Clear status
        form.find('.loading').hide(); // Hide loading indicator
        $('#text-upload-overlay').css('display', 'flex'); // Show overlay
    });

    // *** NEW: Attach handler for the prescription upload button ***
    $('#upload-prescription-btn').off('click').on('click', function() {
         // Clear previous status/file in prescription overlay before showing
         const form = $('#prescription-upload-overlay form');
         form[0].reset();
         form.find('.file-preview').removeClass('active').find('.file-preview-name, .file-preview-size').text('');
         form.find('.upload-status').text('').removeClass('upload-success upload-error');
         form.find('.loading').hide();
         $('#prescription-upload-overlay').css('display', 'flex'); // Show the prescription overlay
    });

    // Add file input handling for preview (KEEP EXISTING - works for both overlays)
    // Use .off().on() here too for safety
    $('.file-input-container input[type="file"]').off('change').on('change',function() {
        const file = this.files[0];
        const form = $(this).closest('form'); // Find the parent form
        const filePreview = form.find('.file-preview'); // Find preview within that form
        if (file) {
            filePreview.addClass('active');
            filePreview.find('.file-preview-name').text(file.name);
            filePreview.find('.file-preview-size').text((file.size / 1024).toFixed(2) + ' KB');
        } else {
             filePreview.removeClass('active'); // Hide if no file selected
        }
    });

    // Document deletion handler (KEEP EXISTING)
    // Use .off().on()
    $('#documents-list').off('click', '.delete-document-btn').on('click', '.delete-document-btn', function(e) {
        e.preventDefault();
        const documentItem = $(this).closest('.document-item');
        const docId = documentItem.data('doc-id');

        if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
            $.ajax({
                url: `/documents/${docId}`,
                method: 'DELETE',
                success: function(response) {
                    documentItem.fadeOut(300, function() {
                        $(this).remove();
                        // Optional: Check if list is empty and show message
                        if ($('#documents-list .document-item').length === 0) {
                            $('#documents-list').html('<p>No documents uploaded yet.</p>');
                        }
                    });
                    // Optionally show a success message using a dedicated feedback area
                },
                error: function(xhr, status, error) {
                    alert('Error deleting document: ' + (xhr.responseJSON?.error || error));
                }
            });
        }
    });

    // Document view handler (KEEP EXISTING)
    // Use .off().on()
    $('#documents-list').off('click', '.view-document-btn').on('click', '.view-document-btn', function(e) {
        e.preventDefault();
        const docId = $(this).closest('.document-item').data('doc-id');
        // Redirect to the dedicated viewer route
        // Consider opening in a new tab: window.open('/documents/' + docId + '/view', '_blank');
        window.location.href = '/documents/' + docId + '/view';
    });

    // Call loadDocuments *inside* function_for_documents to ensure it runs when the section is displayed
    loadDocuments(); // Load the initial list

}

            // Close overlay handlers
            $('.close-overlay, .upload-overlay').click(function(e) {
                if (e.target === this) {
                    $('.upload-overlay').hide();
                }
            });

            // Prevent overlay close when clicking content
            $('.upload-overlay-content').click(function(e) {
                e.stopPropagation();
            });

            // Upload form handler (Modified for safety - this handles BOTH forms now)
$('.upload-form').off('submit').on('submit', function(e) {
    e.preventDefault();

    const form = $(this);
    const formData = new FormData();
    const fileInput = form.find('input[type="file"]')[0];
    const uploadType = form.data('type'); // Reads data-type="text" or data-type="prescription"
    const statusDiv = form.find('.upload-status');
    const loadingDiv = form.find('.loading');
    const submitButton = form.find('button[type="submit"]');

    statusDiv.text('').removeClass('upload-success upload-error'); // Clear status

    if (fileInput.files.length === 0) {
        showUploadStatus(form, 'Please select a file', false);
        return;
    }

    formData.append('file', fileInput.files[0]);

    // Determine the correct URL based on the form's data-type
    const uploadUrl = uploadType === 'prescription' ? '/upload/prescription' : '/upload';

    loadingDiv.show();
    submitButton.prop('disabled', true);

    $.ajax({
        url: uploadUrl,
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            // Use !!response.analysis_performed to check boolean status
            const message = response.message + (response.analysis_performed ? ' Analysis completed.' : ' Analysis skipped or failed.');
            showUploadStatus(form, message, true);

            // Reset form and hide preview after successful upload
            form[0].reset();
            form.find('.file-preview').removeClass('active').find('.file-preview-name, .file-preview-size').text('');

            loadDocuments(); // Refresh the document list in the main view

            // Close overlay after a delay
            setTimeout(() => {
                 // Find the specific overlay this form belongs to and hide it
                 form.closest('.upload-overlay').hide();
            }, 2000); // 2 seconds delay
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : `Upload failed (${xhr.status})`;
            showUploadStatus(form, error, false);
             // Don't reset form on error, user might want to retry
        },
        complete: function() {
            loadingDiv.hide();
            submitButton.prop('disabled', false); // Re-enable button
        }
    });
});
            
            // Show upload status message (KEEP EXISTING)
function showUploadStatus(form, message, success) {
    const statusDiv = form.find('.upload-status');
    statusDiv.removeClass('upload-success upload-error')
        .addClass(success ? 'upload-success' : 'upload-error')
        .text(message).show(); // Make sure it's visible

    // Clear the message after 5 seconds
    setTimeout(function() {
        statusDiv.text('').removeClass('upload-success upload-error').hide();
    }, 5000);
}

            // Update file input accept attribute based on upload type
            $('#upload-type').on('change', function() {
                const fileInput = $('#file-input');
                if ($(this).val() === 'prescription') {
                    fileInput.attr('accept', '.jpg,.jpeg,.png,.pdf');
                } else {
                    fileInput.attr('accept', '.txt');
                }
            });

            /*####################      CHAT     ######################## */

            let currentChatId = null;

            // Global variable to track if user has manually scrolled
            let userHasScrolled = false;

            // Add scroll event listener to detect manual scrolling
            $('#chat-container').on('scroll wheel touchmove', function() {
                const container = $(this);
                const scrollTop = container.scrollTop();
                const scrollHeight = container.prop('scrollHeight');
                const clientHeight = container.prop('clientHeight');
                const scrolledToBottom = Math.abs(scrollHeight - clientHeight - scrollTop) < 50; // 50px threshold

                // If user scrolls away from bottom, mark as manually scrolled
                if (!scrolledToBottom) {
                    userHasScrolled = true;
                }

                // If user manually scrolls back to bottom, reset the flag
                if (scrolledToBottom) {
                    userHasScrolled = false;
                }
            });

            // Modified scroll to bottom function that respects user scroll preference
            let userScrollLock = false;
            function scrollToBottom() {
                if (!userScrollLock) {
                    const container = $('#chat-container');
                    container.stop().animate({
                        scrollTop: container.prop('scrollHeight')
                    }, 300);
                }
            }

            $('#chat-container').on('scroll', function() {
                const container = $(this);
                const threshold = 100;
                userScrollLock = container.scrollTop() + container.innerHeight() < 
                                container.prop('scrollHeight') - threshold;
            });

            function loadChat(chatId) {
                $.get(`/chat/${chatId}`, function(response) {
                    currentChatId = chatId;
                    
                    // Clear and populate chat container
                    const container = $('#chat-container');
                    container.empty();
                    
                    response.messages.forEach(function(message) {
                        container.append(`
                            <div class="message ${message.role}-message">
                                <div class="message-content">${formatMessageHTML(message.content)}</div>
                                <div class="timestamp">${message.timestamp}</div>
                            </div>
                        `);
                    });
                    
                    scrollToBottom();
                });
            }


            $(document).on('click', '#new-chat-btn', function() {
                $('.nav-item').removeClass('active');
                $('#Chatting').addClass('active');
                showContent('Chatting');
                $.post('/chat/new', function(response) {
                    const chatId = response.chat_id;
                    const timestamp = new Date().toLocaleString();
                    currentChatId = chatId;
                    $('#chat-list').prepend(
                        `<div class="chat-item" data-chat-id="${chatId}">
                            <span class="chat-title">Chat</span>
                            <!--<span class="chat-time">${timestamp}</span>-->
                            <button type="button" class="delete-chat-btn" data-chat-id="${chatId}">Delete</button>
                        </div>`
                    );
                    
                    loadChat(chatId);
                });
            });

            // Chat title click handler
            $(document).on('click', '.chat-item', function() {
                $('.nav-item').removeClass('active');
                $('#Chatting').addClass('active');
                showContent('Chatting');
                if (!$(this).find('.edit-title-input').length) {  // Only load chat if not in edit mode
                    const chatId = $(this).closest('.chat-item').data('chat-id');
                    loadChat(chatId);
                }
            });

            // this function to format the message
            function formatMessageHTML(text) {
                // Handle reasoning tags
                //text = text.replace(/<think>([\s\S]*?)<\/think>/g, '<div class="thinking-block">$1</div>');
                
                // Handle markdown-style bold text with ** or __
                text = text.replace(/(\*\*|__)(.*?)\1/g, '<strong>$2</strong>');
                
                // Handle markdown-style italic text with * or _
                text = text.replace(/(\*|_)(.*?)\1/g, '<em>$2</em>');
                
                // Handle single line breaks
                text = text.replace(/\n(?!\n)/g, '<br>');
                
                // Handle paragraphs (double line breaks)
                text = text.split(/\n\n+/).map(paragraph => 
                    `<p>${paragraph.trim()}</p>`
                ).join('');
                
                // Handle markdown headers
                text = text.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
                text = text.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
                text = text.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
                
                // Handle bullet points
                text = text.replace(/^[*-] (.+)$/gm, '<li>$1</li>');
                text = text.replace(/(^<li>.*?<\/li>\n?)+/g, '<ul>$&</ul>');
                
                // Handle numbered lists
                text = text.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
                text = text.replace(/(^<li>.*?<\/li>\n?)+/g, '<ol>$&</ol>');
                
                // Handle code blocks
                text = text.replace(/```([a-z]*)\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
                
                // Handle inline code
                text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                return text;
            }


            // Message input handler for Enter key
            $('#message-input').on('keydown', function(e) {
                // Check if Enter was pressed without Shift key
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevent default newline
                    $('#message-form').submit(); // Submit the form
                    return false;
                }
            });

            $(document).on('submit', '#message-form', function(e) {
                e.preventDefault();
                e.preventDefault();
                // Prevent the default form submission - this is crucial
                e.preventDefault();
                
                // Check if we have a current chat selected
                if (!currentChatId) {
                    alert('Please select or create a new chat first');
                    return false;
                }

                // Get the message input and its value
                const messageInput = $('#message-input');
                const message = messageInput.val().trim();
                
                // Don't proceed if the message is empty
                if (!message) {
                    return false;
                }

                // Clear the input and disable it during processing
                messageInput.val('');
                messageInput.prop('disabled', true);

                // Add the user message to the chat
                const userMessageDiv = $(
                    `<div class="message user-message">
                        <div class="message-content">${formatMessageHTML(message)}</div>
                        <div class="timestamp">${new Date().toLocaleString()}</div>
                    </div>`
                );
                
                $('#chat-container').append(userMessageDiv);
                
                try {
                    // Scroll to bottom manually
                    const container = $('#chat-container');
                    container.scrollTop(container.prop('scrollHeight'));
                    
                    // Create a unique ID for the response
                    const uniqueId = 'streaming-response-' + Date.now();
                    let accumulatedText = '';

                    // Add an assistant message container
                    const assistantMessageDiv = $(
                        `<div class="message assistant-message">
                            <div class="message-content" id="${uniqueId}"></div>
                            <div class="timestamp">${new Date().toLocaleString()}</div>
                        </div>`
                    );
                    
                    $('#chat-container').append(assistantMessageDiv);
                    container.scrollTop(container.prop('scrollHeight'));

                    // Send the message to the server
                    $.ajax({
                        url: `/chat/${currentChatId}/message`,
                        method: 'POST',
                        dataType: 'text', // Process as raw text
                        contentType: 'application/json',
                        data: JSON.stringify({ message: message }),
                        xhr: function() {
                            const xhr = new XMLHttpRequest();
                            let received = 0;
                            
                            xhr.onprogress = function(e) {
                                const text = xhr.responseText.substring(received);
                                received += text.length;
                                
                                // Process each JSON chunk
                                text.split(/(?=\{)/).forEach(chunk => {
                                    try {
                                        const response = JSON.parse(chunk);
                                        if (response.token) {
                                            accumulatedText += response.token;
                                            $(`#${uniqueId}`).html(formatMessageHTML(accumulatedText));
                                            scrollToBottom();
                                        }
                                    } catch(e) {
                                        console.log('Partial chunk:', chunk);
                                    }
                                });
                            };
                            
                            return xhr;
                        },
                        success: function(fullResponse) {
                            // Handle any remaining data
                            $(`#${uniqueId}`).html(formatMessageHTML(accumulatedText));
                            
                            messageInput.prop('disabled', false);
                            messageInput.focus();
                            scrollToBottom();
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX Error:', status, error);
                            console.log('Raw response:', xhr.responseText);
                            let errorMsg = `Error: Request failed (${xhr.status})`;
                            
                            try {
                                // Attempt to parse response even if non-JSON
                                const response = JSON.parse(xhr.responseText);
                                errorMsg = response.error || errorMsg;
                            } catch(e) {
                                errorMsg += `: ${xhr.responseText.substring(0, 50)}...`;
                            }
                            
                            $(`#${uniqueId}`).html(errorMsg);
                            messageInput.prop('disabled', false);
                            
                            // Log detailed error info for debugging
                            if (xhr.status === 500) {
                                console.error('Server error details:', xhr.responseText);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Exception caught:', error);
                    messageInput.prop('disabled', false);
                }
                
                // Return false to ensure the form doesn't submit
                return false;
            });

            // Also fix the message input handler for Enter key
            $(document).on('keydown', '#message-input', function(e) {
                // Check if Enter was pressed without Shift key
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevent default newline
                    $('#message-form').submit(); // Submit the form
                    return false;
                }
            });

            // handle back button
            $(document).on('click', '.button-back-to-chat-history', async function(e) {    
            // Navigate to chat history
            $('.nav-item').removeClass('active');
            $('#ChatHistory-btn').addClass('active');
            showContent('ChatHistory-btn');

            if (currentChatId) {
                try {
                    const response = await $.ajax({
                        url: `/chat/${currentChatId}/generate-title`,
                        method: 'POST',
                        timeout: 30000
                    });

                    // Update title in chat list
                    $(`.chat-item[data-chat-id="${currentChatId}"] .chat-title`)
                        .text(response.title)
                        .css('color', '#333');  // Reset color if previous error

                } catch (error) {
                    console.error('Title generation failed:', error);
                    // Show error state in UI
                    $(`.chat-item[data-chat-id="${currentChatId}"] .chat-title`)
                        .text('Untitled Chat')
                        .css('color', '#999');
                }
            }
        });

            $(document).on('click', '.add-chat-description-btn', async function(e) {
                e.preventDefault();
                const button = $(this);
                const originalText = button.html();
                
                try {
                    button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Generating...');
                    
                    if (!currentChatId) {
                        throw new Error('Please start a chat first');
                    }

                    const response = await $.ajax({
                        url: `/chat/${currentChatId}/summary`,
                        method: 'POST',
                        timeout: 30000  // 30 seconds timeout
                    });

                    // Update UI
                    $(`.chat-item[data-chat-id="${currentChatId}"] .chat-summary p`)
                        .text(response.summary)
                        .css('color', '#666');  // Reset color if previously errored

                } catch (error) {
                    const errorMsg = error.responseJSON?.error || error.statusText || 'Unknown error';
                    console.error('Summary Error:', errorMsg);
                    
                    // Show error in UI
                    $(`.chat-item[data-chat-id="${currentChatId}"] .chat-summary p`)
                        .text('Error generating summary')
                        .css('color', 'red');
                        
                    alert(`Summary failed: ${errorMsg}`);

                } finally {
                    button.prop('disabled', false).html(originalText);
                }
            });
 
            // Edit Chat Title
            $(document).on('click', '.edit-chat-btn', function(e) {
                e.stopPropagation();
                const chatItem = $(this).closest('.chat-item');
                const titleElement = chatItem.find('.chat-title');
                const currentTitle = titleElement.text().trim();
                const chatId = chatItem.data('chat-id');

                // Replace title with input field
                const input = $(`<input type="text" 
                    class="edit-title-input" 
                    value="${currentTitle}"
                    style="width: 80%; 
                        padding: 2px 5px; 
                        border: 1px solid #007bff; 
                        border-radius: 3px;">`);
                
                titleElement.html(input);

                // Use timeout to ensure DOM is ready
                setTimeout(() => {
                    input.focus()[0].select();
                }, 0);

                // Handle saving on Enter
                input.on('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        input.val(currentTitle).blur();
                    }
                });

                // Handle blur event
                input.on('blur', function() {
                    const newTitle = input.val().trim();
                    if (newTitle && newTitle !== currentTitle) {
                        $.ajax({
                            url: `/chat/${chatId}/title`,
                            method: 'PUT',
                            contentType: 'application/json',
                            data: JSON.stringify({ title: newTitle }),
                            success: () => titleElement.text(newTitle),
                            error: () => {
                                alert('Error updating title');
                                titleElement.text(currentTitle);
                            }
                        });
                    } else {
                        titleElement.text(currentTitle);
                    }
                });
            });


            // Chat delete button handler
            $(document).on('click', '.delete-chat-btn', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const chatItem = $(this).closest('.chat-item');
                const chatId = chatItem.data('chat-id');
                
                if (confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
                    $.ajax({
                        url: `/chat/${chatId}/delete`,
                        method: 'DELETE',
                        success: function(response) {
                            chatItem.fadeOut(300, function() {
                                $(this).remove();
                            });
                        },
                        error: function(xhr, status, error) {
                            alert('Error deleting chat: ' + error);
                        }
                    });
                }
            });


            /* ########## DOCUMENT ANALYSIS SECTION   */

            function loadMedicalHistory() {
                fetch('/api/medical-history')
                    .then(response => response.json())
                    .then(data => {
                    const tableBody = document.getElementById('medical-history-table-body');
                    tableBody.innerHTML = data.map(item => `
                        <tr>
                        <td><strong>${item.condition}</strong></td>
                        <td>
                            ${item.category}
                            ${item.diagnosis_date ? `<div><small>Diagnosed: ${item.diagnosis_date}</small></div>` : ''}
                            ${item.notes ? `<div><small>Notes: ${item.notes}</small></div>` : ''}
                        </td>
                        </tr>
                    `).join('');
                });
            }


            function loadPrescriptions() {
                fetch('/api/prescriptions')
                    .then(response => response.json())
                    .then(data => {
                    const tableBody = document.getElementById('prescriptions-table-body');
                    tableBody.innerHTML = data.map(item => `
                        <tr>
                        <td><strong>${item.drug_name}</strong> - ${item.dosage}</td>
                        <td>
                            <div>Frequency: ${item.frequency}</div>
                            ${item.start_date ? `<div><small>Started: ${item.start_date}</small></div>` : ''}
                        </td>
                        </tr>
                    `).join('');
                });
            }


            function loadTestResults() {
                fetch('/api/test-results')
                    .then(response => response.json())
                    .then(data => {
                    const tableBody = document.getElementById('test-results-table-body');
                    tableBody.innerHTML = data.map(item => `
                        <tr>
                        <td><strong>${item.test_name}</strong></td>
                        <td>
                            ${item.result_value}
                            <div>Reference: ${item.reference_range}</div>
                            ${item.date ? `<div><small>Date: ${item.date}</small></div>` : ''}
                        </td>
                        </tr>
                    `).join('');
                });
            }



            /* ###########    Voice Mode Core Functions  ########## */
            
            let isVoiceModeActive = false;
            let mediaRecorder;
            let audioChunks = [];
            let isProcessing = false;
            let currentAudio = null; // To track active audio playback
            let mediaStream = null;    // Track the media stream
            
            

            // Voice Mode UI Handlers
            $('#voice-mode-btn').click(() => {
            if (!isProcessing) {
                activateVoiceMode();

                $('#voice-mode-overlay').css({
                    'background': 'rgba(250, 250, 250, 1)',  
                    'backdrop-filter': 'blur(6px)'
                });
            }
            });


            $('#cancel-voice-mode-btn').click(resetVoiceMode);
            $('#voice-mode-overlay').click(function(e) {
            // Only close if clicking directly on overlay background
            if (e.target === this && !$(e.target).is('button, .close-btn')) {
                resetVoiceMode();
            }
            });

            // Overlay close handlers
            $('#voice-mode-overlay').on('click', '.close-btn', function(e) {
                e.preventDefault();
                resetVoiceMode();
            });
            
            $('#close-voice-mode-btn').click(function(e) {
                e.preventDefault();
                resetVoiceMode();
            });

            // Finish speaking handler  stop recording if active
            $('#finish-speaking-btn').click(() => {
            if (mediaRecorder?.state === 'recording') {
                mediaRecorder.stop();
            }
            });

            let currentVoiceState = null;

            /**
            * Clears and initializes the DNA strands inside the processing state.
            */
            function initProcessingAnimation() {
            const dnaHelix = document.getElementById('dnaHelix');
            // Clear any existing strands
            dnaHelix.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const strand1 = document.createElement('div');
                strand1.className = 'dna-strand';
                strand1.style.top = `${30 + i * 10}%`;
                strand1.style.animation = `wave 1.5s ease-in-out ${i * 0.1}s infinite`;
                
                const strand2 = document.createElement('div');
                strand2.className = 'dna-strand';
                strand2.style.top = `${25 + i * 10}%`;
                strand2.style.animation = `wave 1.5s ease-in-out ${i * 0.1 + 0.75}s infinite reverse`;
                
                dnaHelix.appendChild(strand1);
                dnaHelix.appendChild(strand2);
            }
            }

            /**
            * Clears and initializes the waveform bars inside the speaking state.
            */
            function initSpeakingAnimation() {
            const waveform = document.getElementById('waveform');
            // Clear any existing bars
            waveform.innerHTML = '';
            for (let i = 0; i < 7; i++) {
                const bar = document.createElement('div');
                bar.className = 'waveform-bar';
                bar.style.animation = `speak ${0.6 + i * 0.05}s ease-in-out ${i * 0.08}s infinite`;
                waveform.appendChild(bar);
            }
            }

            /**
            * Updates the voice mode UI state.
            * Shows/hides the new animation elements and initializes dynamic animations if needed.
            */
            function setVoiceState(state) {
            // Hide all animation elements first
            $('#listeningAnimation').hide();
            $('#processingAnimation').hide();
            $('#speakingAnimation').hide();

            if (state === 'listening') {
                $('#listeningAnimation').show();
            } else if (state === 'processing') {
                // Reinitialize DNA strands every time we enter processing state
                initProcessingAnimation();
                $('#processingAnimation').show();
            } else if (state === 'speaking') {
                // Reinitialize waveform bars every time we enter speaking state
                initSpeakingAnimation();
                $('#speakingAnimation').show();
            }

            document.getElementById('voiceStateLabel').innerText = state.charAt(0).toUpperCase() + state.slice(1);
            currentVoiceState = state;

            // Example: Toggle finish button visibility only in listening state
            $('#finish-speaking-btn').toggle(state === 'listening');
            $('#cancel-voice-mode-btn').toggle(state !== 'processing');
            }

            /**
            * Activates voice mode by showing the overlay, setting the state to listening,
            * and then starting microphone capture.
            */
            async function activateVoiceMode() {
                if (isVoiceModeActive) return;
                isVoiceModeActive = true;
                $('#voice-mode-overlay').fadeIn(300, function() {
                    var overlayHeight = $('.voice-overlay-container').outerHeight(true);
                    $('#main-content').addClass('voice-active');
                });
                setVoiceState('listening');
                await startListening();
            }

            /**
            * Resets voice mode by stopping any recording, releasing media, stopping audio playback,
            * and hiding the overlay.
            */
            function resetVoiceMode() {
                isVoiceModeActive = false;
                isProcessing = false;

                if (mediaRecorder) {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                    mediaRecorder = null;
                }

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio = null;
                }

                $('#voice-mode-overlay').fadeOut(300, function() {
                    $('#main-content').removeClass('voice-active').css('margin-top', '0');
                });
                $('#voice-status').text('');

                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => stream.getTracks().forEach(track => track.stop()))
                        .catch(() => {});
                }
            }

            /**
            * Starts microphone capture and recording.
            * Sets the voice state to 'listening' once recording starts.
            */
            async function startListening() {
            console.log('startListening() called');
            try {
                if (mediaRecorder?.state === 'recording') {
                    mediaRecorder.stop();
                    console.log('Active mediaRecorder stopped');
                }
                if (mediaStream) {
                    console.log('Stopping existing mediaStream tracks');
                    mediaStream.getTracks().forEach(t => t.stop());
                }

                console.log('Requesting new microphone access');
                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('Microphone access granted');

                mediaRecorder = new MediaRecorder(mediaStream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => {
                    console.log('MediaRecorder data available');
                    audioChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    console.log('MediaRecorder stopped, processing audio');
                    if (isVoiceModeActive) {
                        processAudio();
                    }
                };

                console.log('Starting new recording');
                mediaRecorder.start();
                setVoiceState('listening');
                console.log('Recording started, state: listening');
            } catch (error) {
                console.error('Microphone error:', error);
                showErrorStatus('Microphone access required');
                resetVoiceMode();
            }
            }

            /**
            * Stops the current recording if active.
            */
            function stopListening() {
            if (mediaRecorder?.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            }

            /**
            * Processes the recorded audio by sending it to the STT endpoint.
            * Sets the UI state to 'processing' during this phase.
            */
            async function processAudio() {
            setVoiceState('processing');
            try {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('audio', audioBlob);

                const response = await fetch('/stt', { method: 'POST', body: formData });
                if (!response.ok) throw new Error('STT failed');

                const data = await response.json();
                console.log("STT Result Data:", JSON.stringify(data)); // <<< ADD THIS
                if (!data.text?.trim()) throw new Error('No text recognized');

                await submitMessage(data.text.trim());
            } catch (error) {
                console.error('Processing error:', error);
                showErrorStatus('Processing failed');
                resetVoiceMode();
            }
            }

            /**
            * Submits the recognized text message.
            * Preserves existing chat submission functionality.
            */
            async function submitMessage(text) {
                //console.log(`Inside submitMessage. currentChatId: ${currentChatId}, text: "${text}"`);

                // 1. Check if text is valid (moved this check up)
                if (!text) {
                    //console.error("submitMessage aborted: text is invalid.");
                    showErrorStatus('Cannot send empty message.');
                    resetVoiceMode(); // Exit processing state
                    return;
                }

                // 2. Check if a chat ID exists, if not, create one
                if (!currentChatId) {
                    //console.log("No currentChatId, attempting to create a new chat.");
                    try {
                        const response = await fetch('/chat/new', {
                            method: 'POST'
                        });
                        if (!response.ok) {
                            throw new Error(`Failed to create new chat: ${response.statusText}`);
                        }
                        const data = await response.json();
                        if (!data.chat_id) {
                            throw new Error('New chat created, but chat_id not received.');
                        }
                        currentChatId = data.chat_id; // <<< UPDATE THE GLOBAL chat ID
                        //console.log(`New chat created successfully. New currentChatId: ${currentChatId}`);

                        // --- Optional: Update the Chat History UI ---
                        // You might want to add the new chat to the sidebar list here
                        // (similar to how your '#new-chat-btn' click handler does)
                        // This requires ensuring your chat list update logic is callable.
                        // Example (you'll need to adapt based on your exact UI update code):
                        // refreshChatList(); // Or a more specific function to add one item

                    } catch (error) {
                        //console.error("Error creating new chat:", error);
                        showErrorStatus('Failed to start a new chat session.');
                        resetVoiceMode(); // Exit processing state
                        return; // Stop if chat creation failed
                    }
                }

                // 3. Now proceed with sending the message (rest of your original function)
                if (!currentChatId || !text) { // This check is now redundant for chatId but keep for text
                    //console.error("Submit message secondary check failed unexpectedly."); // Should not happen now
                    resetVoiceMode();
                    return;
                }

                try {
                    isProcessing = true; // Mark as processing *only when sending message*
                    appendMessage('user', text);
                    const uniqueId = `assistant-msg-${Date.now()}`;
                    appendMessage('assistant', '', uniqueId); // Placeholder for response

                    // Fetch the streaming response
                    const response = await fetch(`/chat/${currentChatId}/message`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text }) // Send the original text
                    });
                    if (!response.ok) {
                        // Try to get error details from backend response if possible
                        let errorMsg = response.statusText;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch(e) {/* Ignore if response not json */}
                        throw new Error(errorMsg);
                    }


                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let accumulatedText = '';
                    let finalResponseHandled = false; // Flag to ensure handleFinalResponse is called only once

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) {
                            //console.log("Stream finished.");
                            // Ensure final handling if 'is_final' wasn't explicitly sent
                            if (!finalResponseHandled && accumulatedText) {
                                //console.log("Stream done, but is_final flag missed. Handling final response now.");
                                await handleFinalResponse(accumulatedText, uniqueId);
                                finalResponseHandled = true;
                            }
                            break; // Exit the loop when the stream is done
                        }

                        const chunk = decoder.decode(value, { stream: true }); // Use stream: true for better multi-byte char handling
                        //console.log("Received chunk:", chunk); // Log the raw chunk

                        // Process potential multiple JSON objects in a single chunk
                        chunk.split('\n').filter(line => line.trim()).forEach(line => {
                            try {
                                const data = JSON.parse(line);
                                //console.log("Parsed data from chunk:", data);

                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                if (data.token) {
                                    accumulatedText += data.token;
                                    updateMessageContent(uniqueId, accumulatedText);
                                }
                                // Check for the final flag - crucial!
                                if (data.is_final === true && !finalResponseHandled) {
                                    console.log("Received is_final flag. Handling final response.");
                                    handleFinalResponse(accumulatedText, uniqueId); // Call your existing handler
                                    finalResponseHandled = true;
                                    // Note: Don't break here, let the stream naturally finish with 'done'
                                }
                            } catch (e) {
                                //console.error("Error parsing JSON line:", e, "Line:", line);
                                // Decide how to handle parse errors - maybe show an error message?
                            }
                        });
                    }

                    // If the loop finishes and final response wasn't handled (e.g., backend forgot is_final)
                    if (!finalResponseHandled && accumulatedText) {
                        //console.warn("Stream ended without explicit is_final=true. Handling final response.");
                        await handleFinalResponse(accumulatedText, uniqueId);
                    }

                } catch (error) {
                    //console.error('Chat Error:', error);
                    showErrorStatus(`Message failed: ${error.message}`);
                    // Ensure we exit processing state on error
                    if (isProcessing) { // Check flag before resetting
                        isProcessing = false;
                        resetVoiceMode(); // Reset UI state on error
                    }
                } finally {
                    // This finally block might run too early if handleFinalResponse is async
                    // It's better to manage isProcessing state within the try/catch and handleFinalResponse
                    // console.log('submitMessage finally block');
                }
            }

            /**
            * Handles the final response by performing TTS playback and then restarting listening.
            */
            async function handleFinalResponse(fullText, uniqueId) {
            console.log('handleFinalResponse started');
            updateMessageContent(uniqueId, fullText);
            await new Promise(resolve => setTimeout(resolve, 500));
            if (isVoiceModeActive) {
                try {
                    console.log('Starting TTS playback');
                    setVoiceState('speaking');
                    await playResponseSpeech(fullText);
                    if (isVoiceModeActive) {
                        console.log('TTS completed, restarting listening');
                        setVoiceState('listening');
                        await startListening();
                    }
                } catch (error) {
                    console.error('TTS Error in handleFinalResponse:', error);
                    showErrorStatus('Speech failed, resuming listening');
                    if (isVoiceModeActive) {
                        setVoiceState('listening');
                        await startListening();
                    }
                }
            }
            console.log('handleFinalResponse completed');
            }

            /**
            * Initiates TTS playback for the given text.
            * Returns a promise that resolves once playback ends.
            */
            async function playResponseSpeech(text) {
            console.log('playResponseSpeech() started');
            try {
                const response = await fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await response.json();
                if (!data.audio_url) throw new Error('No audio URL');

                console.log('TTS audio URL received');
                return new Promise((resolve) => {
                    currentAudio = new Audio(data.audio_url);
                    currentAudio.play();
                    console.log('TTS audio playback started');

                    currentAudio.addEventListener('ended', () => {
                        console.log('TTS audio ended');
                        currentAudio = null;
                        resolve();
                    });

                    currentAudio.addEventListener('error', (e) => {
                        console.error('TTS audio error:', e);
                        currentAudio = null;
                        resolve();
                    });
                });
            } catch (error) {
                console.error('TTS Error:', error);
                showErrorStatus('Speech synthesis failed');
                throw error;
            }
            }

            // UI Helper Functions
            function appendMessage(role, content, id = '') {
                const timestamp = new Date().toLocaleString();
                const message = `
                    <div class="message ${role}-message">
                        <div class="message-content" ${id ? `id="${id}"` : ''}>${formatMessageHTML(content)}</div>
                        <div class="timestamp">${timestamp}</div>
                    </div>
                `;
                $('#chat-container').append(message);
                scrollToBottom();
            }
            
            function updateMessageContent(id, content) {
                $(`#${id}`).html(formatMessageHTML(content));
                scrollToBottom();
            }

            function showErrorStatus(text) {
            $('#voice-status').html(`
                <div class="status-animation error">
                    
                </div>
                ${text}
            `);
            setTimeout(() => $('#voice-status').text(''), 3000);
            }


            /*###############    SETTINGS      ###############*/

            function settings() {
                const profileForm = document.getElementById('profile-info-form');
                const securityForm = document.getElementById('security-form');
                const notificationsForm = document.getElementById('notifications-form');
                const feedbackDiv = document.getElementById('settings-feedback');
                const avatarInput = document.getElementById('avatar-upload-input');
                const avatarImg = document.getElementById('profile-avatar-img');
                const editButtons = document.querySelectorAll('.btn-edit');
                const newPasswordInput = document.getElementById('new-password');
                const strengthMeter = document.querySelector('.password-strength-meter');
                const strengthText = document.querySelector('.password-strength-text');
                const deleteAccountBtn = document.getElementById('delete-account-btn');
                const confirmationModal = document.getElementById('confirmation-modal');
                const confirmationTitle = document.getElementById('confirmation-modal-title');
                const confirmationText = document.getElementById('confirmation-modal-text');
                const confirmBtn = document.getElementById('confirmation-modal-confirm-btn');
                const cancelBtn = document.getElementById('confirmation-modal-cancel-btn');

                // --- Helper Function for Feedback ---
                function showFeedback(message, type = 'success') {
                    feedbackDiv.textContent = message;
                    feedbackDiv.className = `alert-message ${type}`; // Reset classes
                    feedbackDiv.style.display = 'block';
                    // Scroll into view if needed
                    feedbackDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Hide after 5 seconds
                    setTimeout(() => {
                        feedbackDiv.style.display = 'none';
                    }, 5000);
                }

                // --- Avatar Preview ---
                if (avatarInput && avatarImg) {
                    avatarInput.addEventListener('change', function() {
                        const file = this.files[0];
                        if (file && file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                avatarImg.src = e.target.result;
                                // Add logic here to actually upload the avatar via AJAX
                                // showFeedback('Avatar preview updated. Remember to save changes.', 'info'); // Use info type if needed
                            }
                            reader.readAsDataURL(file);
                        } else if (file) {
                            showFeedback('Please select a valid image file (JPG, PNG, GIF, etc.).', 'error');
                            this.value = ''; // Clear invalid file selection
                        }
                    });
                }

                // --- Edit Button Functionality ---
                editButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const targetInput = document.getElementById(this.dataset.target);
                        if (targetInput) {
                            const isReadonly = targetInput.readOnly;
                            targetInput.readOnly = !isReadonly;
                            if (!isReadonly) { // If it was just made editable
                                targetInput.focus();
                                targetInput.select(); // Select text for easy replacement
                                this.innerHTML = '<i class="fas fa-check"></i>'; // Change icon to checkmark
                                this.title = 'Done Editing';
                            } else { // If it was just made readonly again
                                 this.innerHTML = '<i class="fas fa-pencil-alt"></i>'; // Change back to pencil
                                 this.title = targetInput.type === 'email' ? 'Edit Email' : 'Edit Phone';
                                 // Optionally: Add AJAX call here to save the individual field change
                                 // showFeedback(`${targetInput.type === 'email' ? 'Email' : 'Phone'} updated.`, 'success');
                            }
                        }
                    });
                });

                // --- Password Strength Meter ---
                 if (newPasswordInput && strengthMeter && strengthText) {
                    newPasswordInput.addEventListener('input', function() {
                        const password = this.value;
                        let score = 0;
                        let feedback = 'Enter a password';
                        let strengthClass = '';

                        if (password.length >= 8) score++;
                        if (password.length >= 12) score++;
                        if (/[A-Z]/.test(password)) score++; // Uppercase
                        if (/[a-z]/.test(password)) score++; // Lowercase
                        if (/[0-9]/.test(password)) score++; // Numbers
                        if (/[^A-Za-z0-9]/.test(password)) score++; // Symbols

                        let widthPercent = 0;
                        if (password.length > 0) {
                            widthPercent = Math.min((score / 6) * 100, 100); // Cap at 100%
                        }

                        if (password.length === 0){
                            feedback = 'Enter a password';
                            strengthClass = '';
                        } else if (score < 3) {
                            feedback = 'Weak';
                            strengthClass = 'weak';
                        } else if (score < 5) {
                            feedback = 'Medium';
                            strengthClass = 'medium';
                        } else {
                            feedback = 'Strong';
                            strengthClass = 'strong';
                        }

                        strengthMeter.style.width = widthPercent + '%';
                        strengthMeter.className = `password-strength-meter ${strengthClass}`; // Apply class for color
                        strengthText.textContent = feedback;
                    });
                }

                // --- Form Submissions (Example for Profile Info) ---
                if (profileForm) {
                    profileForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        // Add AJAX call here to submit profile data
                        console.log('Submitting Profile Form...');
                        // Example: Get data
                        const fullName = document.getElementById('profile-fullname').value;
                        const dob = document.getElementById('profile-dob').value;
                        const email = document.getElementById('profile-email').value;
                        const phone = document.getElementById('profile-phone').value;
                        // Make sure email/phone are not readonly before submitting if they were edited
                        document.getElementById('profile-email').readOnly = true;
                        document.getElementById('profile-phone').readOnly = true;
                        document.querySelectorAll('.btn-edit[data-target="profile-email"], .btn-edit[data-target="profile-phone"]').forEach(btn => {
                             btn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                             btn.title = btn.dataset.target === 'profile-email' ? 'Edit Email' : 'Edit Phone';
                        });


                        // Simulate successful save
                        setTimeout(() => {
                            showFeedback('Profile information updated successfully!', 'success');
                            // Update display name if changed
                             document.getElementById('profile-user-name-display').textContent = fullName;
                        }, 500);
                         // On error: showFeedback('Failed to update profile. Please try again.', 'error');
                    });
                }

                if (securityForm) {
                     securityForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                         console.log('Submitting Security Form...');
                        const currentPassword = document.getElementById('current-password').value;
                        const newPassword = document.getElementById('new-password').value;
                        const confirmPassword = document.getElementById('confirm-password').value;

                        if (!currentPassword) {
                             showFeedback('Please enter your current password.', 'error');
                             return;
                        }
                         if (newPassword.length < 8) {
                             showFeedback('New password must be at least 8 characters long.', 'error');
                             return;
                         }
                        if (newPassword !== confirmPassword) {
                            showFeedback('New passwords do not match.', 'error');
                            return;
                        }
                        // Add AJAX call here to submit password change
                         setTimeout(() => {
                            showFeedback('Password updated successfully!', 'success');
                            // Clear password fields
                            document.getElementById('current-password').value = '';
                            document.getElementById('new-password').value = '';
                            document.getElementById('confirm-password').value = '';
                             // Reset strength indicator
                             if (strengthMeter && strengthText) {
                                strengthMeter.style.width = '0%';
                                strengthMeter.className = 'password-strength-meter';
                                strengthText.textContent = 'Enter a password';
                            }
                        }, 500);
                         // On error: showFeedback('Failed to update password. Check current password.', 'error');
                    });
                }

                 if (notificationsForm) {
                     notificationsForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                         console.log('Submitting Notifications Form...');
                        // Add AJAX call here to save notification preferences
                         const emailPref = document.getElementById('email-notifications').checked;
                         const smsPref = document.getElementById('sms-notifications').checked;
                         const inAppPref = document.getElementById('inapp-notifications').checked;
                         // Simulate save
                         setTimeout(() => {
                            showFeedback('Notification preferences saved!', 'success');
                        }, 500);
                         // On error: showFeedback('Failed to save preferences.', 'error');
                    });
                }

                 // --- Delete Account Confirmation ---
                let deleteAction = null; // To store the function to run on confirm

                if (deleteAccountBtn && confirmationModal) {
                    deleteAccountBtn.addEventListener('click', function() {
                        confirmationTitle.innerHTML = '<i class="fas fa-trash-alt"></i> Delete Account';
                        confirmationText.textContent = 'Are you absolutely sure you want to delete your account? All your data, including medical history, appointments, and documents, will be permanently removed. This action cannot be undone.';
                        confirmBtn.className = 'btn btn-danger'; // Make confirm button red
                        confirmBtn.textContent = 'Yes, Delete My Account';
                        confirmationModal.style.display = 'flex';

                        deleteAction = function() {
                            console.log("PERMANENTLY DELETING ACCOUNT...");
                            // Add AJAX call here to delete account on the backend
                            confirmationModal.style.display = 'none';
                             // Simulate success - In reality, you'd likely redirect to a logged-out page
                            alert('Account successfully deleted.');
                             // window.location.href = '/logout'; // Redirect after deletion
                        };
                    });
                }

                // --- Generic Confirmation Modal Buttons ---
                if (confirmationModal) {
                    confirmBtn.addEventListener('click', function() {
                        if (typeof deleteAction === 'function') {
                            deleteAction();
                        }
                         deleteAction = null; // Reset action
                    });

                    cancelBtn.addEventListener('click', function() {
                        confirmationModal.style.display = 'none';
                        deleteAction = null; // Reset action
                    });

                    // Close modal clicking background or close button
                    confirmationModal.addEventListener('click', function(e) {
                        if (e.target === confirmationModal || e.target.closest('.close-overlay')) {
                             confirmationModal.style.display = 'none';
                             deleteAction = null; // Reset action
                        }
                    });
                }


            }
            
            
            /*##################   APPOINTMENTS SECTION       ################# */
            function function_for_appointments() { // Corrected function name

                const bookingModal = $('#booking-modal');
                const bookingForm = $('#booking-form');
                const bookingStatus = $('#booking-status');
                const bookingLoading = $('#booking-loading');

                // --- Function to load appointments ---
                function loadAppointments() {
                    const upcomingTbody = $('#upcoming-appointments-body');
                    const pastTbody = $('#past-appointments-body');

                    // Show loading state
                    upcomingTbody.html('<tr><td colspan="6" style="text-align:center;">Loading appointments...</td></tr>');
                    pastTbody.html('<tr><td colspan="5" style="text-align:center;">Loading appointments...</td></tr>');

                    $.get('/appointments')
                        .done(function(data) {
                            upcomingTbody.empty();
                            pastTbody.empty();

                            // --- Populate Upcoming Appointments ---
                            const upcomingAndToday = [...(data.today || []), ...(data.upcoming || [])];
                            upcomingAndToday.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

                            if (upcomingAndToday.length > 0) {
                                upcomingAndToday.forEach(function(appt) {
                                    const apptDateTime = new Date(appt.datetime);
                                    const isToday = apptDateTime.toDateString() === new Date().toDateString();
                                    const dateStr = isToday ? 'Today' : apptDateTime.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
                                    const timeStr = apptDateTime.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                                    const statusLower = (appt.status || 'scheduled').toLowerCase(); // Normalize status

                                    // --- *** START: Conditional Button Logic *** ---
                                    let actionButtonsHTML = '';
                                    if (statusLower === 'canceled') {
                                        // If canceled, show a "Re-enable" button
                                        actionButtonsHTML = `
                                            <button class="btn-primary enable-btn" data-appointment-id="${appt.id}">Re-enable</button>
                                            `;
                                    } else if (statusLower === 'scheduled' || statusLower === 'confirmed') {
                                        // If active (Scheduled/Confirmed), show Reschedule and Cancel
                                        actionButtonsHTML = `
                                            <button class="btn-secondary reschedule-btn" data-appointment-id="${appt.id}">Reschedule</button>
                                            <button class="btn-secondary cancel-btn" data-appointment-id="${appt.id}">Cancel</button>
                                            `;
                                    } else {
                                        // For other statuses (like 'Completed' if it somehow appeared here), show nothing or placeholder
                                        actionButtonsHTML = '<span>-</span>';
                                    }
                                    // --- *** END: Conditional Button Logic *** ---

                                    const row = `
                                        <tr data-appointment-id="${appt.id}">
                                            <td>${dateStr}</td>
                                            <td>${timeStr}</td>
                                            <td>${appt.doctor || 'N/A'}</td>
                                            <td>${appt.type || 'General'}</td>
                                            <td><span class="status-${statusLower}">${appt.status || 'Scheduled'}</span></td>
                                            <td>${actionButtonsHTML}</td>
                                        </tr>
                                    `;
                                    upcomingTbody.append(row);
                                });
                            } else {
                                upcomingTbody.html('<tr><td colspan="6" style="text-align:center;">No upcoming appointments.</td></tr>');
                            }


                            // --- Populate Past Appointments ---
                            if (data.past && data.past.length > 0) {
                                data.past.sort((a, b) => new Date(b.datetime) - new Date(a.datetime)); // Sort past appointments newest first
                                data.past.forEach(function(appt) {
                                    const apptDateTime = new Date(appt.datetime);
                                    const dateStr = apptDateTime.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });

                                    const row = `
                                        <tr data-appointment-id="${appt.id}">
                                            <td>${dateStr}</td>
                                            <td>${appt.doctor || 'N/A'}</td>
                                            <td>${appt.type || 'General'}</td>
                                            <td><span class="status-${(appt.status || 'completed').toLowerCase()}">${appt.status || 'Completed'}</span></td>
                                            <td>
                                                ${appt.notes ? '<button class="btn-secondary view-notes-btn" data-appointment-id="' + appt.id + '">View Notes</button>' : 'No notes'}
                                            </td>
                                        </tr>
                                    `;
                                    pastTbody.append(row);
                                });
                            } else {
                                pastTbody.html('<tr><td colspan="5" style="text-align:center;">No past appointments found.</td></tr>');
                            }
                        })
                        .fail(function(xhr, status, error) {
                            console.error("Error loading appointments:", status, error);
                            upcomingTbody.html('<tr><td colspan="6" style="text-align:center; color: red;">Error loading appointments.</td></tr>');
                            pastTbody.html('<tr><td colspan="5" style="text-align:center; color: red;">Error loading appointments.</td></tr>');
                        });
                }

                // --- Event Handlers (using delegation) ---

                // Handle Reschedule Button Click (MODIFIED)
                $(document).off('click', '.reschedule-btn').on('click', '.reschedule-btn', function() {
                    const appointmentId = $(this).data('appointment-id');
                    console.log("Reschedule clicked for ID:", appointmentId);

                    const rescheduleModal = $('#reschedule-modal');
                    const rescheduleInfo = $('#reschedule-info');
                    const rescheduleForm = $('#reschedule-form');
                    const rescheduleStatus = $('#reschedule-status');
                    const rescheduleDateInput = $('#reschedule-date');
                    const rescheduleTimeInput = $('#reschedule-time');

                    // --- Fetch current appointment details to display ---
                    rescheduleInfo.text('Loading details...'); // Show loading state
                    rescheduleForm[0].reset(); // Clear previous form data
                    rescheduleStatus.text('').removeClass('upload-success upload-error'); // Clear status

                    $.get('/appointments/' + appointmentId) // Assuming GET /appointments/:id exists
                        .done(function(appt) {
                            const apptDateTime = new Date(appt.datetime);
                            const current_dateStr = apptDateTime.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
                             const current_timeStr = apptDateTime.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });

                             // Display info about the appointment being rescheduled
                            rescheduleInfo.html(`
                                Rescheduling appointment with <strong>${appt.doctor || 'Doctor'}</strong>
                                currently on <strong>${current_dateStr} at ${current_timeStr}</strong>.
                            `);

                            // Store the ID in the hidden field
                            $('#reschedule-appointment-id').val(appt.id);

                            // Set minimum date for the new date input to today
                            const today = new Date().toISOString().split('T')[0];
                            rescheduleDateInput.attr('min', today);

                            // --- Pre-fill date/time (Optional but helpful) ---
                             try {
                                // Format current date/time for input fields (YYYY-MM-DD, HH:mm)
                                const yyyy = apptDateTime.getFullYear();
                                const mm = String(apptDateTime.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
                                const dd = String(apptDateTime.getDate()).padStart(2, '0');
                                const hh = String(apptDateTime.getHours()).padStart(2, '0');
                                const min = String(apptDateTime.getMinutes()).padStart(2, '0');

                                rescheduleDateInput.val(`${yyyy}-${mm}-${dd}`);
                                rescheduleTimeInput.val(`${hh}:${min}`);
                            } catch (e) {
                                console.warn("Could not prefill date/time:", e);
                                rescheduleDateInput.val(''); // Clear if error
                                rescheduleTimeInput.val('');
                            }

                            // Show the modal
                            rescheduleModal.fadeIn(200);
                        })
                        .fail(function() {
                            alert(`Could not retrieve details for appointment ${appointmentId}. Cannot reschedule.`);
                            rescheduleInfo.text('Error loading details.'); // Show error in modal briefly
                        });
                });

                // ... (Keep existing handlers for .cancel-btn, .enable-btn, .view-notes-btn) ...

                // --- NEW: Handle Reschedule Form Submission ---
                $('#reschedule-form').off('submit').on('submit', function(e) {
                    e.preventDefault(); // Prevent default page reload

                    const form = $(this);
                    const rescheduleStatus = $('#reschedule-status');
                    const rescheduleLoading = $('#reschedule-loading');
                    const rescheduleModal = $('#reschedule-modal');
                    const submitButton = form.find('button[type="submit"]');

                    rescheduleStatus.text('').removeClass('upload-success upload-error');
                    rescheduleLoading.show();
                    submitButton.prop('disabled', true);

                    // Get data from the form
                    const appointmentId = $('#reschedule-appointment-id').val();
                    const newDate = $('#reschedule-date').val();
                    const newTime = $('#reschedule-time').val();
                    // const rescheduleNotes = $('#reschedule-notes').val(); // If using notes

                    // Basic Validation
                    if (!appointmentId || !newDate || !newTime) {
                        showRescheduleStatus('Please select a new date and time.', false);
                        rescheduleLoading.hide();
                        submitButton.prop('disabled', false);
                        return;
                    }

                    // Combine date and time into an ISO-like string for the backend
                    const newDateTimeISO = `${newDate}T${newTime}:00`; // Add seconds for potential backend parsing

                     // --- Optional: Check if date/time is actually different ---
                    // You might need to fetch the original datetime again or store it
                    // to prevent unnecessary updates if the user didn't change anything.
                    // For simplicity, we'll allow submitting the same date/time for now.

                    // Prepare data for backend
                    const rescheduleData = {
                        appointment_datetime: newDateTimeISO
                        // Optionally add notes: notes: rescheduleNotes
                        // Optionally reset status if needed: status: 'Scheduled'
                    };

                    console.log(`Submitting reschedule for ID ${appointmentId}:`, rescheduleData);

                    // AJAX PUT request
                    $.ajax({
                        url: `/appointments/${appointmentId}`, // Your backend endpoint for updating appointments
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(rescheduleData),
                        success: function(response) {
                            showRescheduleStatus('Appointment rescheduled successfully!', true);
                            setTimeout(() => {
                                rescheduleModal.fadeOut(200); // Close modal after delay
                                loadAppointments(); // Reload the main appointment list
                            }, 1500); // 1.5 second delay
                        },
                        error: function(xhr, status, error) {
                            console.error("Reschedule error:", status, error, xhr.responseText);
                            const errorMsg = xhr.responseJSON?.error || 'Failed to reschedule appointment. Please check date/time and try again.';
                            showRescheduleStatus(errorMsg, false);
                            submitButton.prop('disabled', false); // Re-enable button on error
                        },
                        complete: function() {
                            rescheduleLoading.hide(); // Hide loading indicator
                            // Submit button re-enabled in success/error specific handlers
                        }
                    });
                });

                // Helper function to show status messages in the reschedule modal
                function showRescheduleStatus(message, isSuccess) {
                    $('#reschedule-status')
                        .text(message)
                        .removeClass('upload-success upload-error')
                        .addClass(isSuccess ? 'upload-success' : 'upload-error');
                }

                // Handle Cancel Button Click
                $(document).off('click', '.cancel-btn').on('click', '.cancel-btn', function() {
                    const appointmentId = $(this).data('appointment-id');
                    const button = $(this); // Store reference to the button
                    console.log("Cancel clicked for ID:", appointmentId);
                    if (confirm(`Are you sure you want to cancel this appointment?`)) {
                        button.prop('disabled', true).text('Canceling...'); // Disable button
                        $.ajax({
                            url: `/appointments/${appointmentId}`,
                            method: 'PUT',
                            contentType: 'application/json',
                            data: JSON.stringify({ status: 'Canceled' }),
                            success: function(response) {
                                // alert('Appointment canceled successfully.'); // Can remove alert if UI updates clearly
                                loadAppointments(); // Reload the list
                            },
                            error: function(xhr, status, error) {
                                console.error("Error canceling appointment:", status, error);
                                alert('Failed to cancel appointment. Please try again.');
                                button.prop('disabled', false).text('Cancel'); // Re-enable button on error
                            }
                            // No need for 'complete' if success handles reload and error handles re-enable
                        });
                    }
                });

                // Handle View Notes Button Click
                $(document).off('click', '.view-notes-btn').on('click', '.view-notes-btn', function() {
                    const appointmentId = $(this).data('appointment-id');
                    console.log("View Notes clicked for ID:", appointmentId);
                    // Example: Fetch notes and display in a simple alert (replace with modal later)
                    $.get('/appointments/' + appointmentId) // Fetch full appointment data
                        .done(function(data) {
                            // Assuming backend sends single appointment details at /appointments/<id>
                            // Or modify backend to have /appointments/<id>/notes
                            // For now, let's assume the full appointment object IS returned
                            alert(`Notes for Appointment with ${data.doctor} on ${new Date(data.datetime).toLocaleDateString()}:\n\n${data.notes || 'No notes available.'}`);
                        })
                        .fail(function() {
                            alert(`Could not retrieve details for appointment ${appointmentId}.`);
                        });
                });

                // --- *** NEW: Handle Re-enable Button Click *** ---
                $(document).off('click', '.enable-btn').on('click', '.enable-btn', function() {
                    const appointmentId = $(this).data('appointment-id');
                    const button = $(this); // Store reference to the button
                    console.log("Enable clicked for ID:", appointmentId);

                    // Optional confirmation, might not be needed for re-enabling
                    // if (confirm('Are you sure you want to re-enable this appointment?')) {

                        button.prop('disabled', true).text('Enabling...'); // Disable button
                        $.ajax({
                            url: `/appointments/${appointmentId}`,
                            method: 'PUT',
                            contentType: 'application/json',
                            data: JSON.stringify({ status: 'Scheduled' }), // Set status back
                            success: function(response) {
                                // alert('Appointment re-enabled successfully.'); // Optional
                                loadAppointments(); // Reload the list to reflect the change
                            },
                            error: function(xhr, status, error) {
                                console.error("Error re-enabling appointment:", status, error);
                                alert('Failed to re-enable appointment. Please try again.');
                                button.prop('disabled', false).text('Re-enable'); // Re-enable button on error
                            }
                        });
                    // } // End optional confirmation
                });

                // --- Booking Modal Logic ---

                // Handle Book New Appointment Button Click (Opens Modal)
                $(document).off('click', '#book-new-appointment-btn').on('click', '#book-new-appointment-btn', function() {
                    console.log("Book New Appointment clicked - opening modal");
                    bookingStatus.text('').removeClass('upload-success upload-error'); // Clear status
                    bookingForm[0].reset(); // Reset form fields
                    // Set minimum date for the date input to today
                    const today = new Date().toISOString().split('T')[0];
                    $('#appointment-date').attr('min', today);
                    bookingModal.fadeIn(200); // Use fadeIn or css('display', 'flex')
                });

                // Handle Modal Close Button Click
                bookingModal.off('click', '.close-overlay').on('click', '.close-overlay', function() {
                    $(this.dataset.target).fadeOut(200); // Close the modal targeted by the button
                });

                // Handle Clicking Outside Modal Content to Close
                bookingModal.off('click').on('click', function(e) {
                    if ($(e.target).is(bookingModal)) { // Check if the click is directly on the overlay background
                        bookingModal.fadeOut(200);
                    }
                });

                // Handle Booking Form Submission
                bookingForm.off('submit').on('submit', function(e) {
                    e.preventDefault(); // Prevent default page reload
                    bookingStatus.text('').removeClass('upload-success upload-error'); // Clear previous status
                    bookingLoading.show(); // Show loading indicator
                    const submitButton = $(this).find('button[type="submit"]');
                    submitButton.prop('disabled', true); // Disable submit button

                    // Get form data
                    const patientName = $('#patient-name').val();
                    const doctorName = $('#doctor-name').val();
                    const appointmentType = $('#appointment-type').val();
                    const appointmentDate = $('#appointment-date').val();
                    const appointmentTime = $('#appointment-time').val();
                    const appointmentNotes = $('#appointment-notes').val();

                    // Basic Validation (ensure date and time are selected)
                    if (!appointmentDate || !appointmentTime) {
                        showBookingStatus('Please select both a date and a time.', false);
                        bookingLoading.hide();
                        submitButton.prop('disabled', false);
                        return;
                    }

                    // Combine date and time into an ISO string (assuming local time)
                    // IMPORTANT: The backend needs to handle this correctly.
                    const appointmentDateTimeISO = `${appointmentDate}T${appointmentTime}:00`; // Adds seconds

                    // Prepare data for backend
                    const bookingData = {
                        patient_name: patientName,
                        doctor_name: doctorName,
                        appointment_datetime: appointmentDateTimeISO,
                        type: appointmentType,
                        notes: appointmentNotes
                        // Status will likely default to 'Scheduled' on the backend
                    };

                    console.log("Submitting booking data:", bookingData);

                    // AJAX POST request
                    $.ajax({
                        url: '/appointments', // Your backend endpoint for creating appointments
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(bookingData),
                        success: function(response) {
                            showBookingStatus('Appointment booked successfully!', true);
                            bookingForm[0].reset(); // Clear the form
                            setTimeout(() => {
                                bookingModal.fadeOut(200); // Close modal after a short delay
                                loadAppointments(); // Reload the main appointment list
                            }, 1500); // 1.5 second delay
                        },
                        error: function(xhr, status, error) {
                            console.error("Booking error:", status, error, xhr.responseText);
                            const errorMsg = xhr.responseJSON?.error || 'Failed to book appointment. Please check details and try again.';
                            showBookingStatus(errorMsg, false);
                        },
                        complete: function() {
                            bookingLoading.hide(); // Hide loading indicator
                            submitButton.prop('disabled', false); // Re-enable submit button
                        }
                    });
                });

                // Helper function to show status messages in the modal
                function showBookingStatus(message, isSuccess) {
                    bookingStatus
                        .text(message)
                        .removeClass('upload-success upload-error')
                        .addClass(isSuccess ? 'upload-success' : 'upload-error');
                }

                // --- Modal Close Handlers (Ensure they cover the new modal) ---
                $('.close-overlay').off('click.closemodal').on('click.closemodal', function() {
                    // Use data-target to close the specific modal
                    const targetModal = $(this).data('target');
                    if (targetModal) {
                         $(targetModal).fadeOut(200);
                    } else {
                         // Fallback for older close buttons without data-target
                         $(this).closest('.upload-overlay').fadeOut(200);
                    }
                });

                // Handle Clicking Outside Modal Content to Close (Generalized)
                $('.upload-overlay').off('click.closemodalbg').on('click.closemodalbg', function(e) {
                    if ($(e.target).is('.upload-overlay')) { // Check if the click is directly on the overlay background
                        $(this).fadeOut(200);
                    }
                });

                // --- Initial Load ---
                loadAppointments();
                
            } // End of function_for_appointments

            // Close overlay handlers (Modified for safety)
            $('.close-overlay').off('click.closemodal').on('click.closemodal', function(e) {
                const targetModal = $(this).data('target'); // Use data-target attribute
                if (targetModal) {
                    $(targetModal).hide();
                } else {
                    // Fallback for buttons without data-target
                    $(this).closest('.upload-overlay').hide();
                }
            });

            // Close overlay by clicking background (Modified for safety)
            $('.upload-overlay').off('click.closebg').on('click.closebg', function(e) {
                // Check if the direct target of the click is the overlay itself
                if (e.target === this) {
                    $(this).hide();
                }
            });

            /*----------------------------------------------------------------------------------------------------------*/
        });
    </script>
</body>
</html>
